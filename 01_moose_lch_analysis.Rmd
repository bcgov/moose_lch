---
title: "Moose Landcape Change Hypothesis Analysis"
author: "Tyler Muhly"
date: "12/12/2019"
output: html_document
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library (data.table)
library (downloader)
library (dplyr)
library (ggplot2)
library (here)
library (lwgeom)
library (sf)

```

## Introduction

 provide spaital information on wildlfie habitat that can be linked to wildlife popualtion data


## Methods

### Study area
- 5 study areas

- 100% MCP of annual cooalred adult female moose in each area

- 4 years of data

```{r, management unit spatial data, echo = T, message = F, warning = F}

# load the mcp's
poly.sa.bc.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2014_15_MCP"), 
                         crs = 3005) # setting these all to the same coordinate system
poly.sa.bc.14.15$year <- 2015 # add year
poly.sa.bc.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2015_16_MCP"), 
                         crs = 3005)
poly.sa.bc.15.16$year <- 2016 # add year
poly.sa.bc.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2016_17_MCP"), 
                         crs = 3005)
poly.sa.bc.16.17$year <- 2017 # add year
poly.sa.bc.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2017_18_MCP"), 
                         crs = 3005)
poly.sa.bc.17.18$year <- 2018 # add year
poly.sa.jprf.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2014_15_MCP"), 
                         crs = 3005)
poly.sa.jprf.14.15$year <- 2015 
poly.sa.jprf.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2015_16_MCP"), 
                         crs = 3005)
poly.sa.jprf.15.16$year <- 2016 
poly.sa.jprf.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2016_17_MCP"), 
                         crs = 3005)
poly.sa.jprf.16.17$year <- 2017
poly.sa.jprf.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2017_18_MCP"), 
                         crs = 3005)
poly.sa.jprf.17.18$year <- 2018
poly.sa.pgs.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2014_15_MCP"), 
                         crs = 3005)
poly.sa.pgs.14.15$year <- 2015
poly.sa.pgs.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2015_16_MCP"), 
                         crs = 3005)
poly.sa.pgs.15.16$year <- 2016
poly.sa.pgs.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2016_17_MCP"), 
                         crs = 3005)
poly.sa.pgs.16.17$year <- 2017
poly.sa.pgs.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2017_18_MCP"), 
                         crs = 3005)  
poly.sa.pgs.17.18$year <- 2018
poly.sa.bon.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon14_15MCP.mhp")), 
                         crs = 3005)
poly.sa.bon.14.15$year <- 2015
poly.sa.bon.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon15_16MCP.mhp")), 
                         crs = 3005)
poly.sa.bon.15.16$year <- 2016
poly.sa.bon.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon16_17MCP.mhp")), 
                         crs = 3005)
poly.sa.bon.16.17$year <- 2017
poly.sa.bon.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon17_18MCP.mhp")), 
                         crs = 3005)
poly.sa.bon.17.18$year <- 2018
poly.sa.entiako <- st_transform (st_read (dsn = here ( "./data/mcp/entiako/mmcp100.mhp")), 
                         crs = 3005)

# bind them up by area, add area names adn make fields consistent
# Big Creek
poly.sa.bc <- rbind (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
poly.sa.bc$name_sa <- "Big Creek"
poly.sa.bc$area_ha <- poly.sa.bc$area * 0.0001
poly.sa.bc$Shape_Length <- NULL
poly.sa.bc$Shape_Area <- NULL
poly.sa.bc$area <- NULL
poly.sa.bc$id <- 1
names(poly.sa.bc)[names(poly.sa.bc) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.bc) <- "geometry"
rm (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
gc ()

# John Prince Research Forest
poly.sa.jprf <- rbind (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
names(poly.sa.jprf)[names(poly.sa.jprf) == "Id"] = "id" # rename the Id column
poly.sa.jprf$id <- 2
poly.sa.jprf$area_ha <- (st_area (poly.sa.jprf$Shape) * 0.0001) # area needs to be calc'd
poly.sa.jprf$name_sa <- "John Prince Research Forest"
poly.sa.jprf$Shape_Length <- NULL
poly.sa.jprf$Shape_Area <- NULL
names(poly.sa.jprf)[names(poly.sa.jprf) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.jprf) <- "geometry"
rm (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
gc ()

# Prince George South
poly.sa.pgs <- rbind (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
names(poly.sa.pgs)[names(poly.sa.pgs) == "Id"] = "id" 
poly.sa.pgs$id <- 3
poly.sa.pgs$area_ha <- (st_area (poly.sa.pgs$Shape) * 0.0001)
poly.sa.pgs$name_sa <- "Prince George South"
poly.sa.pgs$Shape_Length <- NULL
poly.sa.pgs$Shape_Area <- NULL
names(poly.sa.pgs)[names(poly.sa.pgs) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.pgs) <- "geometry"
rm (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
gc ()

# Bonaparte
poly.sa.bon <- rbind (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
names(poly.sa.bon)[names(poly.sa.bon) == "Id"] = "id" 
poly.sa.bon$id <- 4
poly.sa.bon$area_ha <- (st_area (poly.sa.bon$geometry) * 0.0001)
poly.sa.bon$name_sa <- "Bonaparte"
rm (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
gc ()

# Entiako
poly.sa.entiako$year <- 2014
poly.sa.entiako [2, 4] <- 2015 # making year consitent with other data
poly.sa.entiako [3, 4] <- 2016
poly.sa.entiako [4, 4] <- 2017
poly.sa.entiako [5, 4] <- 2018
poly.sa.entiako$name_sa <- "Entiako"
poly.sa.entiako$id <- 5
poly.sa.entiako$area_ha <- poly.sa.entiako$area
poly.sa.entiako$area <- NULL

# all together now...
poly.sa <- rbind (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
rm (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
gc ()

# unique identifier for each
poly.sa$unique_id <- with (poly.sa, paste0 (as.character (name_sa), as.character (year)))

# save it 
st_write (poly.sa, 
          dsn = here ("./data/mcp/"), 
          layer = "study_area_mcp_moose", 
          driver = "ESRI Shapefile")
```

### Measuring Spatial Habtiat in Areas

- testing efefct of two forest distruabnce types: cutblcoks and betteles usign publically available provinvial data

#### Cutblocks
I estimated the area of cutblocks in each management area using the BC governments [consolidated cutblock data ](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-). I calculated the amount of area cut each year from 1960 to 2018, and the area cut between 1950 to 1959 and prior to 1950. 

```{r, cutblock data download and attribute to study areas, echo = T, message = F, warning = F}

# library (bcdata) # use this to conenct to bcgw via R
# cutblocks <- bcdc_get_data ('b1b647a6-f271-42e0-9cd0-89ec24bce9f7', resource = '66656966-8af6-4e32-8de1-b79c63cae40f') # name of the data in BCGW; I noticed there are 413451 rows form here, whereas 446,987 in the BCGW; not sure why they are different, but this version likely underestimates the area of cutblocks; so I used the BCGW data and imported it here...
cutblocks <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\moose_lch.gdb",
                          layer = "cutblocks_20191217")
cutblocks <- lwgeom::st_make_valid (cutblocks) # fix any geometry errors

# intersect cutblocks with study area values
sa.cutblocks <- sf::st_intersection (cutblocks, poly.sa ["unique_id"]) # intersect the study area ID
table.sa.cutblocks <- as.data.table (sa.cutblocks)

# summarize cut by study area
table.sa.cutblocks.mum <- table.sa.cutblocks %>% 
                             group_by (unique_id, HARVEST_YEAR) %>%
                             summarise (area_ha = sum (AREA_HA)) # calculate area of cut by year

# get study area id
poly.sa.habitat <- as.data.table (poly.sa)
poly.sa.habitat$geometry <- NULL

## these next steps left-join the cutblock data to wmu data ##
### Subset the harvest years ###
#### 1980 to 2018 ####
fxn.cut.year <- function (year, table.sa.cutblocks.mum, poly.sa.habitat) {
  table <- as.data.table (table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR == year, ])
  table [, paste0 ("cut_", year, "_area_ha") := area_ha] 
  table$area_ha <- NULL
  table$HARVEST_YEAR <- NULL
  setkey (table, unique_id)
  setkey (poly.sa.habitat, unique_id)
  poly.sa.habitat <- merge (poly.sa.habitat, table, all.x = TRUE)
  poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
  poly.sa.habitat <<- poly.sa.habitat
}

year <- 2018
fxn.cut.year (year, table.sa.cutblocks.mum, poly.sa.habitat)
  
#### 1970 to 1979 ####
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR > 1969 & table.sa.cutblocks.mum$HARVEST_YEAR < 1980, ]
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.1970to1979.mum %>% 
                                          group_by (unique_id) %>%
                                          summarise (area_ha = sum (area_ha))
table.sa.cutblocks.1970to1979.mum$cut_1970to1979_area_ha <- table.sa.cutblocks.1970to1979.mum$area_ha
table.sa.cutblocks.1970to1979.mum$area_ha <- NULL
table.sa.cutblocks.1970to1979.mum <- as.data.table(table.sa.cutblocks.1970to1979.mum)
setkey (table.sa.cutblocks.1970to1979.mum, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.sa.cutblocks.1970to1979.mum, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
rm (table.sa.cutblocks.1970to1979.mum)
gc ()

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

rm (cutblocks, table.sa.cutblocks, table.sa.cutblocks.mum, sa.cutblocks)
gc ()
```

#### Beetle Disturbances
I measured insect disturbance in management areas using data collected by the government of British Columbia using aerial survey  [methods](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/forest-health/aerial-overview-surveys/methods). Data are accessible through an [FTP site](https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/), and I downloaded annual datsets from 1999 to 2017.  

I summarized the area of moderate (11 to 29%), severe (30 to 49%) and very severe (>50%) levels of disturbance from bettle's including: mountain pine beetle, spruce beetle, Dougals fir beetle, western balsam bark beetle and western pine beetle in each WMU. 

```{r, forest health data download and attribute beetle disturbance to study areas, echo = T, message = F, warning = F}


# Download data; this is an example; do these for each year and save it locally
download ("https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/1999/shape/Prov_Shape.zip", 
            dest = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
            mode = "wb")
unzip ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
       exdir = "C:\\Work\\caribou\\clus_data\\forest_health\\1999")
file.remove ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip")

#################
# 1999 to 2018 #
###############
fh.1999 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\Prov_Shape\\FHF_Poly_1999.shp")
mpb.1999 <- dplyr::filter (fh.1999, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.1999) = 3005
mpb.1999.sa <- sf::st_intersection (mpb.1999 [c ("SEVERITY", "YEAR", "POLY_AREA")], poly.sa ["unique_id"])
rm (fh.1999, mpb.1999)
gc ()


# Make this a fucntion 





fh.2000 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2000\\shape\\prv_ibm.shp")
mpb.2000 <- dplyr::filter (fh.2000, SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2000) = 3005
mpb.2000.sa <- sf::st_intersection (mpb.2000, poly.sa ["unique_id"])
rm (fh.2000, mpb.2000)
gc ()







fh.2001 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2001\\prv_poly.shp")
fh.2001 <- lwgeom::st_make_valid (fh.2001)
mpb.2001 <- dplyr::filter (fh.2001, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2001) = 3005
mpb.2001.sa <- sf::st_intersection (mpb.2001, poly.sa ["unique_id"])
rm (fh.2001, mpb.2001)
gc ()

fh.2002 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2002\\prv_poly.shp")
mpb.2002 <- dplyr::filter (fh.2002, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2002) = 3005
mpb.2002.sa <- sf::st_intersection (mpb.2002, poly.sa ["unique_id"])
rm (fh.2002, mpb.2002)
gc ()

fh.2003 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2003\\SHAPE_FILES\\fhf_poly_2003.shp")
mpb.2003 <- dplyr::filter (fh.2003, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2003) = 3005
mpb.2003.sa <- sf::st_intersection (mpb.2003, poly.sa ["unique_id"])
rm (fh.2003, mpb.2003)
gc ()

fh.2004 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2004\\fhf_poly_2004.shp")
mpb.2004 <- dplyr::filter (fh.2004, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2004) = 3005
mpb.2004.sa <- sf::st_intersection (mpb.2004, poly.sa ["unique_id"])
rm (fh.2004, mpb.2004)
gc ()

fh.2005 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2005\\fhf_poly.shp")
mpb.2005 <- dplyr::filter (fh.2005, FHF == "IBM" & SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")  # mountain pine beetle, severity = moderate, severe or very severe
st_crs (mpb.2005) = 3005
mpb.2005.sa <- sf::st_intersection (mpb.2005, poly.sa ["unique_id"])
rm (fh.2005, mpb.2005)
gc ()




# erase polygons previous years 1999 that were re-classified (overlap) in subsequent years
mpb_erase <- st_difference (st_make_valid (mpb.1999.sa), st_make_valid (st_union (st_combine (mpb.2000.sa))))


# merge them back together 
mpb_cumulative <- rbind (mpb.2000.sa, mpb_erase)?

# save it 
st_write (mpb_cumulative, 
          dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_cumulative", 
          layer = "mpb_cumul_1999", 
          driver = "ESRI Shapefile")






# function to add mpb
fxn.mpb.severity <- function (mpb, year, severity, poly.sa.habitat, poly.sa) {
  poly <- sf::st_intersection (mpb, poly.sa ["unique_id"])
  table <- as.data.table (poly)  
  table.sum <- as.data.table (table [, sum (POLY_AREA), by = unique_id])
  setnames (table.sum, c("unique_id", "V1"), c("unique_id", paste0 ("mpb_", year, severity, "_area_ha")))
  setkey (table.sum, unique_id)
  setkey (poly.sa.habitat, unique_id)
  poly.sa.habitat <- merge (poly.sa.habitat, table.sum, all.x = TRUE)
  poly.sa.habitat [is.na (poly.sa.habitat)] <- 0
  poly.sa.habitat <<- poly.sa.habitat
}

fh.2018 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2018\\AOS_2018_Poly_Jan21.shp")
mpb.2018 <- dplyr::filter (fh.2018, FHF == "IBM")  # mountain pine beetle type
st_crs (mpb.2018) = 3005
mpb.2018.vs <- dplyr::filter (mpb.2018, SEVERITY == "V") # severity types: very severe (>50% of Trees in Polygon Recently Killed)
mpb.2018.s <- dplyr::filter (mpb.2018, SEVERITY == "S") # severe (30% to 49%)
mpb.2018.m <- dplyr::filter (mpb.2018, SEVERITY == "M") # moderate (11% to 29%)

# fxn parameters
year <- 2018
severity <- "versev" # "mod", "sev", "versev"
mpb <- mpb.2018.vs

fxn.mpb.severity (mpb, year, severity, poly.sa.habitat, poly.sa)


rm (mpb.2018.vs, mpb.2018.s, mpb.2018.m, sa.mpb.2018.m, sa.mpb.2018.s, sa.mpb.2018.vs, table.sa.mpb.2018.m, table.sa.mpb.2018.m.sum, table.sa.mpb.2018.s, table.sa.mpb.2018.s.sum, table.sa.mpb.2018.vs, table.sa.mpb.2018.vs.sum, fh.2018, mpb.2018)
gc ()

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

```

### CUmulative Disturbance

- 'disturabnce' = area cut 1-8 years old + area beetle 1-8 yeas old (and 15 years, 25 years prior to each 'survival' year)

- last year of survival year is year of distiurbance data, e.g., 2014/15 survival year = 2015 disturabnce year 

- for mpb, surveys done in July-Aug, so use year before to assign mpb imapct to study area, e.g., if study area year = 2018, use 2017 mpb disturbnace 


```{r, cumulative sum disturbance, echo = T, message = F, warning = F}

# 8 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_8_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha]
poly.sa.habitat [year == 2015, cut_8_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha] #where year = 2015
poly.sa.habitat [year == 2016, cut_8_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha] #where year = 2016
poly.sa.habitat [year == 2017, cut_8_year_area_ha := cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha] 
poly.sa.habitat [year == 2018, cut_8_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha] 

# Cumulative mpb  
### NOTE: for MPB, each year survey is cumulative, impact of previous years are included in last year, so use last year value and extends form 1999 to present




poly.sa.habitat [year == 2014, mpb_vs_8_year_area_ha := mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha]
poly.sa.habitat [year == 2015, mpb_vs_8_year_area_ha := mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha]
poly.sa.habitat [year == 2016, mpb_vs_8_year_area_ha := mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha]
poly.sa.habitat [year == 2017, mpb_vs_8_year_area_ha := mpb_2017versev_area_ha + mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha]
poly.sa.habitat [year == 2018, mpb_vs_8_year_area_ha := mpb_2018versev_area_ha + mpb_2017versev_area_ha + mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha]

# 8 year cumulative mpb severe disturbance 
poly.sa.habitat [year == 2014, mpb_s_8_year_area_ha := mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha]
poly.sa.habitat [year == 2015, mpb_s_8_year_area_ha := mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha]
poly.sa.habitat [year == 2016, mpb_s_8_year_area_ha := mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha]
poly.sa.habitat [year == 2017, mpb_s_8_year_area_ha := mpb_2017sev_area_ha + mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha]
poly.sa.habitat [year == 2018, mpb_s_8_year_area_ha := mpb_2018sev_area_ha + mpb_2017sev_area_ha + mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha]

# 8 year cumulative mpb moderate disturbance 
poly.sa.habitat [year == 2014, mpb_m_8_year_area_ha := mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha]
poly.sa.habitat [year == 2015, mpb_m_8_year_area_ha := mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha]
poly.sa.habitat [year == 2016, mpb_m_8_year_area_ha := mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha]
poly.sa.habitat [year == 2017, mpb_m_8_year_area_ha := mpb_2017mod_area_ha + mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha]
poly.sa.habitat [year == 2018, mpb_m_8_year_area_ha := mpb_2018mod_area_ha + mpb_2017mod_area_ha + mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha]

# cumulative mod, severe and very severe
poly.sa.habitat [, mpb_all_8_year_area_ha := mpb_m_8_year_area_ha + mpb_s_8_year_area_ha + mpb_vs_8_year_area_ha]

# 15 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_15_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha]
poly.sa.habitat [year == 2015, cut_15_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha] 
poly.sa.habitat [year == 2016, cut_15_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha] 
poly.sa.habitat [year == 2017, cut_15_year_area_ha := cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha] 
poly.sa.habitat [year == 2018, cut_15_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha] 

# 15 year cumulative mpb very severe disturbance 
poly.sa.habitat [year == 2014, mpb_vs_15_year_area_ha := mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha + mpb_2006versev_area_ha + mpb_2005versev_area_ha + mpb_2004versev_area_ha + mpb_2003versev_area_ha + mpb_2002versev_area_ha + mpb_2001versev_area_ha + mpb_2000versev_area_ha]
poly.sa.habitat [year == 2015, mpb_vs_15_year_area_ha := mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha + mpb_2006versev_area_ha + mpb_2005versev_area_ha + mpb_2004versev_area_ha + mpb_2003versev_area_ha + mpb_2002versev_area_ha + mpb_2001versev_area_ha]
poly.sa.habitat [year == 2016, mpb_vs_15_year_area_ha := mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha + mpb_2006versev_area_ha + mpb_2005versev_area_ha + mpb_2004versev_area_ha + mpb_2003versev_area_ha + mpb_2002versev_area_ha]
poly.sa.habitat [year == 2017, mpb_vs_15_year_area_ha := mpb_2017versev_area_ha + mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha + mpb_2006versev_area_ha + mpb_2005versev_area_ha + mpb_2004versev_area_ha + mpb_2003versev_area_ha]
poly.sa.habitat [year == 2018, mpb_vs_15_year_area_ha := mpb_2018versev_area_ha + mpb_2017versev_area_ha + mpb_2016versev_area_ha + mpb_2015versev_area_ha + mpb_2014versev_area_ha + mpb_2013versev_area_ha + mpb_2012versev_area_ha + mpb_2011versev_area_ha + mpb_2010versev_area_ha + mpb_2009versev_area_ha + mpb_2008versev_area_ha + mpb_2007versev_area_ha + mpb_2006versev_area_ha + mpb_2005versev_area_ha + mpb_2004versev_area_ha]

# 15 year cumulative mpb severe disturbance 
poly.sa.habitat [year == 2014, mpb_s_15_year_area_ha := mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha + mpb_2006sev_area_ha + mpb_2005sev_area_ha + mpb_2004sev_area_ha + mpb_2003sev_area_ha + mpb_2002sev_area_ha + mpb_2001sev_area_ha + mpb_2000sev_area_ha]
poly.sa.habitat [year == 2015, mpb_s_15_year_area_ha := mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha + mpb_2006sev_area_ha + mpb_2005sev_area_ha + mpb_2004sev_area_ha + mpb_2003sev_area_ha + mpb_2002sev_area_ha + mpb_2001sev_area_ha]
poly.sa.habitat [year == 2016, mpb_s_15_year_area_ha := mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha + mpb_2006sev_area_ha + mpb_2005sev_area_ha + mpb_2004sev_area_ha + mpb_2003sev_area_ha + mpb_2002sev_area_ha]
poly.sa.habitat [year == 2017, mpb_s_15_year_area_ha := mpb_2017sev_area_ha + mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha + mpb_2006sev_area_ha + mpb_2005sev_area_ha + mpb_2004sev_area_ha + mpb_2003sev_area_ha]
poly.sa.habitat [year == 2018, mpb_s_15_year_area_ha := mpb_2018sev_area_ha + mpb_2017sev_area_ha + mpb_2016sev_area_ha + mpb_2015sev_area_ha + mpb_2014sev_area_ha + mpb_2013sev_area_ha + mpb_2012sev_area_ha + mpb_2011sev_area_ha + mpb_2010sev_area_ha + mpb_2009sev_area_ha + mpb_2008sev_area_ha + mpb_2007sev_area_ha + mpb_2006sev_area_ha + mpb_2005sev_area_ha + mpb_2004sev_area_ha]

# 15 year cumulative mpb moderate disturbance 
poly.sa.habitat [year == 2014, mpb_m_15_year_area_ha := mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha + mpb_2006mod_area_ha + mpb_2005mod_area_ha + mpb_2004mod_area_ha + mpb_2003mod_area_ha + mpb_2002mod_area_ha + mpb_2001mod_area_ha + mpb_2000mod_area_ha]
poly.sa.habitat [year == 2015, mpb_m_15_year_area_ha := mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha + mpb_2006mod_area_ha + mpb_2005mod_area_ha + mpb_2004mod_area_ha + mpb_2003mod_area_ha + mpb_2002mod_area_ha + mpb_2001mod_area_ha]
poly.sa.habitat [year == 2016, mpb_m_15_year_area_ha := mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha + mpb_2006mod_area_ha + mpb_2005mod_area_ha + mpb_2004mod_area_ha + mpb_2003mod_area_ha + mpb_2002mod_area_ha]
poly.sa.habitat [year == 2017, mpb_m_15_year_area_ha := mpb_2017mod_area_ha + mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha + mpb_2006mod_area_ha + mpb_2005mod_area_ha + mpb_2004mod_area_ha + mpb_2003mod_area_ha]
poly.sa.habitat [year == 2018, mpb_m_15_year_area_ha := mpb_2018mod_area_ha + mpb_2017mod_area_ha + mpb_2016mod_area_ha + mpb_2015mod_area_ha + mpb_2014mod_area_ha + mpb_2013mod_area_ha + mpb_2012mod_area_ha + mpb_2011mod_area_ha + mpb_2010mod_area_ha + mpb_2009mod_area_ha + mpb_2008mod_area_ha + mpb_2007mod_area_ha + mpb_2006mod_area_ha + mpb_2005mod_area_ha + mpb_2004mod_area_ha]

# 15 year cumulative mod, severe and very severe
poly.sa.habitat [, mpb_all_15_year_area_ha := mpb_m_15_year_area_ha + mpb_s_15_year_area_ha + mpb_vs_15_year_area_ha]

# 15 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_25_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha + cut_1990_area_ha]
poly.sa.habitat [year == 2015, cut_25_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha] 
poly.sa.habitat [year == 2016, cut_25_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha] 
poly.sa.habitat [year == 2017, cut_25_year_area_ha := cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha] 
poly.sa.habitat [year == 2018, cut_25_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha] 

write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

poly.sa.habitat.sum <- poly.sa.habitat [, .(unique_id, id, year, name_sa, area_ha, cut_8_year_area_ha, cut_15_year_area_ha, cut_25_year_area_ha, mpb_all_8_year_area_ha, mpb_all_15_year_area_ha, mpb_m_8_year_area_ha, mpb_s_8_year_area_ha, mpb_vs_8_year_area_ha, mpb_m_15_year_area_ha, mpb_s_15_year_area_ha, mpb_vs_15_year_area_ha)]

write.csv (poly.sa.habitat.sum, here ("./data/study_area_habitat_sum.csv"))

```

### Population Parameters
- dependent variables are:
    - annual survival rate, human and all mortality types?
    - change in annual survival rate, human and all mortality types?
    - change in density 

```{r population params table, echo = T, message = F, warning = F}

table.pop.data = data.table(
  unique_id = c ("Big Creek2015", "Big Creek2016", "Big Creek2017", "Big Creek2018", "Bonaparte2015",
                 "Bonaparte2016", "Bonaparte2017", "Bonaparte2018", "Entiako2014", "Entiako2015", 
                 "Entiako2016", "Entiako2017", "Entiako2018", "John Prince Research Forest2015",
                 "John Prince Research Forest2016", "John Prince Research Forest2017",
                 "John Prince Research Forest2018", "Prince George South2015", 
                 "Prince George South2016", "Prince George South2017", "Prince George South2018"),
  af_survival_rate_all = c (0.923, 0.862, 0.897, 0.901, 0.912, 0.871, 0.906, 0.977, 0.970, 0.913,
                            0.799, 0.775, 0.817, 1, 0.923, 0.949, 0.951, 0.875, 0.842, 0.946, 0.794),
  af_survival_rate_all_95CI = c (0.085, 0.103, 0.143, 0.092, 0.130, 0.092, 0.124, 0.045, NA, 0.081, 
                                 0.111, 0.168, 0.133, 0, 0.084, 0.110, 0.066, 0.162, 0.118, 0.151, 
                                 0.122),
  calves_100cows = c(37, 33, 27, 32, 25, 26, 16, 38, NA, NA, 14, 9, 15, 8, 17, 40, 37, 39, 27, 40,
                     26),
  density = c(170, NA, NA, 220, 296, NA, NA, 254, NA, 267, NA, NA, 217, 770, NA, NA, 490, 630, NA, 
              NA, 400),
  density_95CI = c(39, NA, NA, 38, 18, NA, NA, 41, NA, 45, NA, NA, 46, 93, NA, NA, 84, 102, NA, NA, 
                   78)
)

# link pop table to habitat table
setkey (table.pop.data, unique_id)
setkey (poly.sa.habitat.sum, unique_id)
data <- merge (table.pop.data, poly.sa.habitat.sum, all.x = TRUE)

# convert areas to proportion of study area
data [, prop_cut_8_year_area_ha := cut_8_year_area_ha / area_ha]
data [, prop_cut_15_year_area_ha := cut_15_year_area_ha / area_ha]
data [, prop_cut_25_year_area_ha := cut_25_year_area_ha / area_ha]
data [, prop_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha / area_ha]
data [, prop_mpb_m_15_year_area_ha := mpb_m_15_year_area_ha / area_ha]



# get change in values for comapring rates of change
data [, delta_af_survival_rate_all := af_survival_rate_all - shift (af_survival_rate_all, n = 1, type = "lag"), by = name_sa]
data [, delta_calves_100cows := calves_100cows - shift (calves_100cows, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_8_year_area_ha := cut_8_year_area_ha - shift (cut_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_15_year_area_ha := cut_15_year_area_ha - shift (cut_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_25_year_area_ha := cut_25_year_area_ha - shift (cut_25_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha - shift (mpb_m_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_all_15_year_area_ha := mpb_all_15_year_area_ha - shift (mpb_all_15_year_area_ha, n = 1, type = "lag"), by = name_sa]








write.csv (data, here ("./data/data.csv"))
```


### Descriptive Stats and Visualization
- look at distribtuion of data 

```{r exploratory stats and data vis, echo = T, message = F, warning = F}

ggplot (data, aes (x = pttype, y = slope)) +
  geom_point()



### OUTLIERS ###
ggplot (data, aes (x = pttype, y = slope)) +
        geom_boxplot (outlier.colour = "red") +
        labs (title = "Boxplot DU7, Early Winter Slope at Available (0) and Used (1) Locations",
              x = "Available (0) and Used (1) Locations",
              y = "Slope")



### HISTOGRAMS ###
ggplot (rsf.data.terrain.water.du7.ew, aes (x = slope, fill = pttype)) + 
          geom_histogram (position = "dodge", binwidth = 5) +
          labs (title = "Histogram DU7, Early Winter Slope at Available (0) and Used (1) Locations",
                x = "Slope",
                y = "Count") +
          scale_fill_discrete (name = "Location Type")


### CORRELATION ###
corr.terrain.water.du7.ew <- rsf.data.terrain.water.du7.ew [c (10:15)]
corr.terrain.water.du7.ew <- round (cor (corr.terrain.water.du7.ew, method = "spearman"), 3)
ggcorrplot (corr.terrain.water.du7.ew, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Terrain and Water Resource Selection Function Model
            Covariate Correlations for DU7, Early Winter")
ggsave ("C:\\Work\\caribou\\clus_github\\reports\\caribou_rsf\\plots\\corr_terrain_water_du7_ew.png")



```



### Model


