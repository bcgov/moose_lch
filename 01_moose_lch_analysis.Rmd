---
title: "Moose Landcape Change Hypothesis Analysis"
author: "Tyler Muhly"
date: "12/12/2019"
output: html_document
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (data.table)
library (downloader)
library (dplyr)
library (ggplot2)
library (here)
library (lwgeom)
library (sf)
```

## Introduction

 provide spaital information on wildlfie habitat that can be linked to wildlife popualtion data


## Methods

### Study area
- 5 study areas

- 100% MCP of annual cooalred adult female moose in each area

- 4 years of data

```{r, management unit spatial data, echo = T, message = F, warning = F}

# load the mcp's
poly.sa.bc.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2014_15_MCP"), 
                         crs = 3005) # setting these all to the same coordinate system
poly.sa.bc.14.15$year <- 2015 # add year
poly.sa.bc.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2015_16_MCP"), 
                         crs = 3005)
poly.sa.bc.15.16$year <- 2016 # add year
poly.sa.bc.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2016_17_MCP"), 
                         crs = 3005)
poly.sa.bc.16.17$year <- 2017 # add year
poly.sa.bc.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2017_18_MCP"), 
                         crs = 3005)
poly.sa.bc.17.18$year <- 2018 # add year
poly.sa.jprf.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2014_15_MCP"), 
                         crs = 3005)
poly.sa.jprf.14.15$year <- 2015 
poly.sa.jprf.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2015_16_MCP"), 
                         crs = 3005)
poly.sa.jprf.15.16$year <- 2016 
poly.sa.jprf.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2016_17_MCP"), 
                         crs = 3005)
poly.sa.jprf.16.17$year <- 2017
poly.sa.jprf.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2017_18_MCP"), 
                         crs = 3005)
poly.sa.jprf.17.18$year <- 2018
poly.sa.pgs.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2014_15_MCP"), 
                         crs = 3005)
poly.sa.pgs.14.15$year <- 2015
poly.sa.pgs.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2015_16_MCP"), 
                         crs = 3005)
poly.sa.pgs.15.16$year <- 2016
poly.sa.pgs.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2016_17_MCP"), 
                         crs = 3005)
poly.sa.pgs.16.17$year <- 2017
poly.sa.pgs.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2017_18_MCP"), 
                         crs = 3005)  
poly.sa.pgs.17.18$year <- 2018
poly.sa.bon.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon14_15MCP.shp")), 
                         crs = 3005)
poly.sa.bon.14.15$year <- 2015
poly.sa.bon.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon15_16MCP.shp")), 
                         crs = 3005)
poly.sa.bon.15.16$year <- 2016
poly.sa.bon.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon16_17MCP.shp")), 
                         crs = 3005)
poly.sa.bon.16.17$year <- 2017
poly.sa.bon.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon17_18MCP.shp")), 
                         crs = 3005)
poly.sa.bon.17.18$year <- 2018
poly.sa.entiako <- st_transform (st_read (dsn = here ( "./data/mcp/entiako/mmcp100.shp")), 
                         crs = 3005)

# bind them up by area, add area names adn make fields consistent
# Big Creek
poly.sa.bc <- rbind (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
poly.sa.bc$name_sa <- "Big Creek"
poly.sa.bc$area_ha <- poly.sa.bc$area * 0.0001
poly.sa.bc$Shape_Length <- NULL
poly.sa.bc$Shape_Area <- NULL
poly.sa.bc$area <- NULL
poly.sa.bc$id <- 1
names(poly.sa.bc)[names(poly.sa.bc) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.bc) <- "geometry"
rm (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
gc ()

# John Prince Research Forest
poly.sa.jprf <- rbind (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
names(poly.sa.jprf)[names(poly.sa.jprf) == "Id"] = "id" # rename the Id column
poly.sa.jprf$id <- 2
poly.sa.jprf$area_ha <- (st_area (poly.sa.jprf$Shape) * 0.0001) # area needs to be calc'd
poly.sa.jprf$name_sa <- "John Prince Research Forest"
poly.sa.jprf$Shape_Length <- NULL
poly.sa.jprf$Shape_Area <- NULL
names(poly.sa.jprf)[names(poly.sa.jprf) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.jprf) <- "geometry"
rm (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
gc ()

# Prince George South
poly.sa.pgs <- rbind (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
names(poly.sa.pgs)[names(poly.sa.pgs) == "Id"] = "id" 
poly.sa.pgs$id <- 3
poly.sa.pgs$area_ha <- (st_area (poly.sa.pgs$Shape) * 0.0001)
poly.sa.pgs$name_sa <- "Prince George South"
poly.sa.pgs$Shape_Length <- NULL
poly.sa.pgs$Shape_Area <- NULL
names(poly.sa.pgs)[names(poly.sa.pgs) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.pgs) <- "geometry"
rm (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
gc ()

# Bonaparte
poly.sa.bon <- rbind (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
names(poly.sa.bon)[names(poly.sa.bon) == "Id"] = "id" 
poly.sa.bon$id <- 4
poly.sa.bon$area_ha <- (st_area (poly.sa.bon$geometry) * 0.0001)
poly.sa.bon$name_sa <- "Bonaparte"
rm (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
gc ()

# Entiako
poly.sa.entiako$year <- 2014
poly.sa.entiako [2, 4] <- 2015 # making year consitent with other data
poly.sa.entiako [3, 4] <- 2016
poly.sa.entiako [4, 4] <- 2017
poly.sa.entiako [5, 4] <- 2018
poly.sa.entiako$name_sa <- "Entiako"
poly.sa.entiako$id <- 5
poly.sa.entiako$area_ha <- poly.sa.entiako$area
poly.sa.entiako$area <- NULL

# all together now...
poly.sa <- rbind (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
rm (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
gc ()

# unique identifier for each
poly.sa$unique_id <- with (poly.sa, paste0 (as.character (name_sa), as.character (year)))

# save it 
st_write (poly.sa, 
          dsn = here ("./data/mcp/"), 
          layer = "study_area_mcp_moose", 
          driver = "ESRI Shapefile")
```

### Measuring Spatial Habtiat in Areas

- testing efefct of two forest distruabnce types: cutblcoks and betteles usign publically available provinvial data

#### Cutblocks
I estimated the area of cutblocks in each management area using the BC governments [consolidated cutblock data ](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-). I calculated the amount of area cut each year from 1960 to 2018, and the area cut between 1950 to 1959 and prior to 1950. 

```{r, cutblock data download and attribute to study areas, echo = T, message = F, warning = F}

# library (bcdata) # use this to conenct to bcgw via R
# cutblocks <- bcdc_get_data ('b1b647a6-f271-42e0-9cd0-89ec24bce9f7', resource = '66656966-8af6-4e32-8de1-b79c63cae40f') # name of the data in BCGW; I noticed there are 413451 rows form here, whereas 446,987 in the BCGW; not sure why they are different, but this version likely underestimates the area of cutblocks; so I used the BCGW data and imported it here...
cutblocks <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\moose_lch.gdb",
                          layer = "cutblocks_20191217")
cutblocks <- lwgeom::st_make_valid (cutblocks) # fix any geometry errors

# intersect cutblocks with study area values
sa.cutblocks <- sf::st_intersection (cutblocks, poly.sa ["unique_id"]) # intersect the study area ID
table.sa.cutblocks <- as.data.table (sa.cutblocks)

# summarize cut by study area
table.sa.cutblocks.mum <- table.sa.cutblocks %>% 
                             group_by (unique_id, HARVEST_YEAR) %>%
                             summarise (area_ha = sum (AREA_HA)) # calculate area of cut by year

# get study area id
poly.sa.habitat <- as.data.table (poly.sa)
poly.sa.habitat$geometry <- NULL

## these next steps left-join the cutblock data to wmu data ##
### Subset the harvest years ###
#### 1980 to 2018 ####
fxn.cut.year <- function (year, table.sa.cutblocks.mum, poly.sa.habitat) {
  table <- as.data.table (table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR == year, ])
  table [, paste0 ("cut_", year, "_area_ha") := area_ha] 
  table$area_ha <- NULL
  table$HARVEST_YEAR <- NULL
  setkey (table, unique_id)
  setkey (poly.sa.habitat, unique_id)
  poly.sa.habitat <- merge (poly.sa.habitat, table, all.x = TRUE)
  poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
  poly.sa.habitat <<- poly.sa.habitat
}

year <- 2018
fxn.cut.year (year, table.sa.cutblocks.mum, poly.sa.habitat)
  
#### 1970 to 1979 ####
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR > 1969 & table.sa.cutblocks.mum$HARVEST_YEAR < 1980, ]
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.1970to1979.mum %>% 
                                          group_by (unique_id) %>%
                                          summarise (area_ha = sum (area_ha))
table.sa.cutblocks.1970to1979.mum$cut_1970to1979_area_ha <- table.sa.cutblocks.1970to1979.mum$area_ha
table.sa.cutblocks.1970to1979.mum$area_ha <- NULL
table.sa.cutblocks.1970to1979.mum <- as.data.table(table.sa.cutblocks.1970to1979.mum)
setkey (table.sa.cutblocks.1970to1979.mum, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.sa.cutblocks.1970to1979.mum, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
rm (table.sa.cutblocks.1970to1979.mum)
gc ()

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

rm (cutblocks, table.sa.cutblocks, table.sa.cutblocks.mum, sa.cutblocks)
gc ()
```

#### Beetle Disturbances
I measured insect disturbance in management areas using data collected by the government of British Columbia using aerial survey  [methods](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/forest-health/aerial-overview-surveys/methods). Data are accessible through an [FTP site](https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/), and I downloaded annual datsets from 1999 to 2018.  

I summarized the area of moderate (11 to 29%), severe (30 to 49%) and very severe (>50%) levels of disturbance from bettle's including: mountain pine beetle, spruce beetle, Dougals fir beetle, western balsam bark beetle and western pine beetle in each WMU. 

```{r, forest health data download and attribute beetle disturbance to study areas, echo = T, message = F, warning = F}

# Download data; this is an example; do these for each year and save it locally
download ("https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/1999/shape/Prov_Shape.zip", 
            dest = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
            mode = "wb")
unzip ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
       exdir = "C:\\Work\\caribou\\clus_data\\forest_health\\1999")
file.remove ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip")


#########################################################
# Determine MPB affected stands by year - 1998 to 2008 #
#######################################################

#------------------------------------------------------
# I found that MPB data wasn't updated annualy, e.g., a surveyed stand in 1998 
# may not necessarily be re-surveyd in 1999. So, I had to 'erase' current years data from previous years data (cumulative), and then merge that with the cumulative mpb disturbance to date
### in R, but it TOOK AWHILE, SO I DID THE GIS PROCESSING IN ARCGIS ###

# do the analysis using the data processed in ArcGIS
  # cliped to study area
  # unioned with study area
  # area in ha calc (POLY_AREA)

  # erase new data from previosu data
  # merge new data to cumualtve data

# function to load and overlay mpb data by year and study area 

fxn.mpb.summary <- function (dsn, survey.year, poly.sa.habitat) {
fh <- sf::st_read (dsn = paste0 (dsn))
mpb <- fh %>%
        filter(FHF == "IBM") %>%
        filter (SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")
table <- as.data.table (mpb)  
table$survey.year <- paste0 (survey.year)
table.cast <- as.data.table (dcast (table, 
                                    unique_id ~ YEAR_1 + SEVERITY + survey.year, 
                                    value.var = "POLY_AREA",  
                                    fun = sum))
setkey (table.cast, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.cast, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0
poly.sa.habitat <<- poly.sa.habitat
}

# fxn.mpb.summary (dsn, survey.year, poly.sa.habitat)

fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_1999_sa_union.shp", 
 "survey1999", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2000_cumul.shp", 
  "survey2000", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2001_cumul.shp", 
  "survey2001", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2002_cumul.shp", 
 "survey2002", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2003_cumul.shp", 
 "survey2003", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2004_cumul.shp", 
  "survey2004", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2005_cumul.shp", 
  "survey2005", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2006_cumul.shp", 
  "survey2006", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2007_cumul.shp", 
  "survey2007", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2008_cumul.shp", 
  "survey2008", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2009_cumul.shp", 
  "survey2009", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2010_cumul.shp", 
  "survey2010", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2011_cumul.shp", 
  "survey2011", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2012_cumul.shp", 
  "survey2012", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2013_cumul.shp", 
  "survey2013", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2014_cumul.shp", 
 "survey2014", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2015_cumul.shp", 
  "survey2015", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2016_cumul.shp", 
  "survey2016", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2017_cumul.shp", 
  "survey2017", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2018_cumul.shp", 
  "survey2018", 
   poly.sa.habitat)

# severity types: very severe (>50% of Trees in Polygon Recently Killed), severe (30% to 49%), moderate (11% to 29%)

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))
```

### CUmulative Disturbance

- 'disturabnce' = area cut 1-8 years old + area beetle 1-8 yeas old (and 15 years, 25 years prior to each 'survival' year)

- last year of survival year is year of distiurbance data, e.g., 2014/15 survival year = 2015 disturabnce year 

- for mpb, surveys done in July-Aug, so use year before to assign mpb imapct to study area, e.g., if study area year = 2018, use 2017 mpb disturbnace 


```{r, cumulative sum disturbance, echo = T, message = F, warning = F}

# 8 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_8_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha]
poly.sa.habitat [year == 2015, cut_8_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha] #where year = 2015
poly.sa.habitat [year == 2016, cut_8_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha] #where year = 2016
poly.sa.habitat [year == 2017, cut_8_year_area_ha := cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha] 
poly.sa.habitat [year == 2018, cut_8_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha] 

# Cumulative mpb  
### NOTE: for MPB, each year survey is cumulative, impact of previous years are included in last year, so use last survey year 
poly.sa.habitat [year == 2014, mpb_m_8_year_area_ha := `2013_M_survey2014` + `2012_M_survey2014` + `2011_M_survey2014` + `2010_M_survey2014` + `2009_M_survey2014` + `2008_M_survey2014` + `2007_M_survey2014` + `2006_M_survey2014`]
poly.sa.habitat [year == 2014, mpb_s_8_year_area_ha :=   `2012_S_survey2014` + `2010_S_survey2014` + `2009_S_survey2014` + `2008_S_survey2014` + `2007_S_survey2014` + `2006_S_survey2014`] # no data  `2013_S_survey2014` +  `2011_S_survey2014` +
poly.sa.habitat [year == 2014, mpb_vs_8_year_area_ha :=  `2011_V_survey2014` +  `2009_V_survey2014` + `2008_V_survey2014` + `2007_V_survey2014` + `2006_V_survey2014`] # no data `2013_V_survey2014` +  `2012_V_survey2014` + `2010_V_survey2014` +

poly.sa.habitat [year == 2015, mpb_m_8_year_area_ha := `2014_M_survey2015` + `2013_M_survey2015` + `2012_M_survey2015` + `2011_M_survey2015` + `2010_M_survey2015` + `2009_M_survey2015` + `2008_M_survey2015` + `2007_M_survey2015`]
poly.sa.habitat [year == 2015, mpb_s_8_year_area_ha :=  `2012_S_survey2015` + `2010_S_survey2015` + `2009_S_survey2015` + `2008_S_survey2015` + `2007_S_survey2015`] # no data  `2014_S_survey2015` + `2013_S_survey2015` + `2011_S_survey2015` +
poly.sa.habitat [year == 2015, mpb_vs_8_year_area_ha :=   `2011_V_survey2015` +   `2009_V_survey2015` + `2008_V_survey2015` + `2007_V_survey2015`] # no data `2014_VS_survey2015` + `2013_V_survey2015` + `2012_V_survey2015` + `2010_V_survey2015` +

poly.sa.habitat [year == 2016, mpb_m_8_year_area_ha := `2015_M_survey2016` + `2014_M_survey2016` + `2013_M_survey2016` + `2012_M_survey2016` + `2011_M_survey2016` + `2010_M_survey2016` +`2009_M_survey2016` + `2008_M_survey2016`]
poly.sa.habitat [year == 2016, mpb_s_8_year_area_ha :=   `2012_S_survey2016` +  `2010_S_survey2016` + `2009_S_survey2016` + `2008_S_survey2016`] # no data  `2015_S_survey2016` + `2014_S_survey2016` + `2013_S_survey2016` + `2011_S_survey2016` + 
poly.sa.habitat [year == 2016, mpb_vs_8_year_area_ha :=  `2011_V_survey2016` + `2008_V_survey2016`] # no data `2015_VS_survey2016` + `2014_V_survey2016` + `2013_V_survey2016` +  `2010_V_survey2016` +  `2012_V_survey2016` +    

poly.sa.habitat [year == 2017, mpb_m_8_year_area_ha := `2016_M_survey2017` + `2015_M_survey2017` + `2014_M_survey2017` + `2013_M_survey2017` + `2012_M_survey2017` + `2011_M_survey2017` + `2010_M_survey2017` + `2009_M_survey2017`]
poly.sa.habitat [year == 2017, mpb_s_8_year_area_ha :=  `2016_S_survey2017` +  `2012_S_survey2017` + `2010_M_survey2017` + `2009_M_survey2017`] # no data `2015_S_survey2017` + `2014_S_survey2017` + `2013_S_survey2017` +  `2011_S_survey2017` + 
poly.sa.habitat [year == 2017, mpb_vs_8_year_area_ha :=  `2011_V_survey2017` +  `2009_V_survey2017`] # no data 2016_VS_survey2017` + `2015_V_survey2017` + `2014_V_survey2017` + `2013_V_survey2017`  + `2012_V_survey2017` + `2010_V_survey2017` +

poly.sa.habitat [year == 2018, mpb_m_8_year_area_ha := `2017_M_survey2018` + `2016_M_survey2018` + `2015_M_survey2018` + `2014_M_survey2018` + `2013_M_survey2018` + `2012_M_survey2018`  + `2011_M_survey2018`  + `2010_M_survey2018`]
poly.sa.habitat [year == 2018, mpb_s_8_year_area_ha :=  `2017_S_survey2018` +  `2016_S_survey2018` + `2012_S_survey2018` +  `2010_S_survey2018`] # no data  `2015_S_survey2018` + `2014_S_survey2018` + `2013_S_survey2018` + `2011_S_survey2018` +
poly.sa.habitat [year == 2018, mpb_vs_8_year_area_ha :=  `2011_V_survey2018`] # no data `2018_V_survey2018` + `2017_VS_survey2018` +  `2017_V_survey2018` +  `2015_V_survey2018` + `2014_V_survey2018`  +  `2013_V_survey2018` + `2012_V_survey2018` + + `2010_V_survey2018`

# cumulative mod, severe and very severe
poly.sa.habitat [, mpb_all_8_year_area_ha := mpb_m_8_year_area_ha + mpb_s_8_year_area_ha + mpb_vs_8_year_area_ha]

# 15 year cumulative mpb disturbance 
poly.sa.habitat [year == 2014, mpb_m_15_year_area_ha := `2013_M_survey2014` + `2012_M_survey2014` + `2011_M_survey2014` + `2010_M_survey2014` + `2009_M_survey2014` + `2008_M_survey2014` + `2007_M_survey2014` + `2006_M_survey2014` + `2005_M_survey2014` + `2004_M_survey2014` + `2003_M_survey2014` + `2002_M_survey2014` + `2001_M_survey2014` + `2000_M_survey2014` + `1999_M_survey2014`]
poly.sa.habitat [year == 2014, mpb_s_15_year_area_ha :=   `2012_S_survey2014` + `2010_S_survey2014` + `2009_S_survey2014` + `2008_S_survey2014` + `2007_S_survey2014` + `2006_S_survey2014` + `2005_S_survey2014` + `2004_S_survey2014` + `2003_S_survey2014` + `2002_S_survey2014` + `2001_S_survey2014` + `2000_S_survey2014` + `1999_S_survey2014`] # no data  `2013_S_survey2014` +  `2011_S_survey2014` +
poly.sa.habitat [year == 2014, mpb_vs_15_year_area_ha :=    `2011_V_survey2014` + `2009_V_survey2014` + `2008_V_survey2014` + `2007_V_survey2014` + `2006_V_survey2014` + `2005_V_survey2014` + `2004_V_survey2014` + `2003_V_survey2014`] # no data  `2000_V_survey2014` + `2013_V_survey2014` + `2012_V_survey2014` + `2002_V_survey2014` + `2010_V_survey2014` + `2001_V_survey2014`  + `1999_V_survey2014`   
 
poly.sa.habitat [year == 2015, mpb_m_15_year_area_ha := `2014_M_survey2015` + `2013_M_survey2015` + `2012_M_survey2015` + `2011_M_survey2015` + `2010_M_survey2015` + `2009_M_survey2015` + `2008_M_survey2015` + `2007_M_survey2015` + `2006_M_survey2015` + `2005_M_survey2015` + `2004_M_survey2015` + `2003_M_survey2015` + `2002_M_survey2015` + `2001_M_survey2015` + `2000_M_survey2015`]
poly.sa.habitat [year == 2015, mpb_s_15_year_area_ha :=    `2012_S_survey2015` +  `2010_S_survey2015` + `2009_S_survey2015` + `2008_S_survey2015` + `2007_S_survey2015` + `2006_S_survey2015` + `2005_S_survey2015` + `2004_S_survey2015` + `2003_S_survey2015` + `2002_S_survey2015` + `2001_S_survey2015` + `2000_S_survey2015`] # no data `2014_S_survey2015` + `2013_S_survey2015` + `2011_S_survey2015` +  
poly.sa.habitat [year == 2015, mpb_vs_15_year_area_ha :=  `2011_V_survey2015` + `2009_V_survey2015` + `2008_V_survey2015` + `2007_V_survey2015` + `2006_V_survey2015` + `2005_V_survey2015` + `2004_V_survey2015` + `2003_V_survey2015` ] # no data  `2014_V_survey2015` +  `2013_V_survey2015` +  `2012_V_survey2015` +  `2010_V_survey2015` +  `2002_V_survey2015`  + `2001_V_survey2015` + `2000_V_survey2015`   

poly.sa.habitat [year == 2016, mpb_m_15_year_area_ha := `2015_M_survey2016` + `2014_M_survey2016` + `2013_M_survey2016` + `2012_M_survey2016` + `2011_M_survey2016` + `2010_M_survey2016` + `2009_M_survey2016` + `2008_M_survey2016` + `2007_M_survey2016` + `2006_M_survey2016` + `2005_M_survey2016` + `2004_M_survey2016` + `2003_M_survey2016` + `2002_M_survey2016` + `2001_M_survey2016`]
poly.sa.habitat [year == 2016, mpb_s_15_year_area_ha := `2012_S_survey2016` +  `2010_S_survey2016` + `2009_S_survey2016` + `2008_S_survey2016` + `2007_S_survey2016` + `2006_S_survey2016` + `2005_S_survey2016` + `2004_S_survey2016` + `2003_S_survey2016` + `2002_S_survey2016` + `2001_S_survey2016`] # no data `2015_S_survey2016` + `2014_S_survey2016` +   `2013_S_survey2016` + `2011_S_survey2016` +
poly.sa.habitat [year == 2016, mpb_vs_15_year_area_ha :=   `2011_V_survey2016` +   `2009_V_survey2016` + `2008_V_survey2016` + `2007_V_survey2016` + `2006_V_survey2016` + `2005_V_survey2016` + `2004_V_survey2016` + `2003_V_survey2016` ] # no data  `2015_V_survey2016` +  `2014_V_survey2016` +  `2013_V_survey2016` + `2012_V_survey2016` +  `2010_V_survey2016` +  `2002_V_survey2016` + `2001_V_survey2016`

poly.sa.habitat [year == 2017, mpb_m_15_year_area_ha := `2016_M_survey2017` + `2015_M_survey2017` + `2014_M_survey2017` + `2013_M_survey2017` + `2012_M_survey2017` + `2011_M_survey2017` + `2010_M_survey2017` + `2009_M_survey2017` + `2008_M_survey2017` + `2007_M_survey2017` + `2006_M_survey2017` + `2005_M_survey2017` + `2004_M_survey2017` + `2003_M_survey2017` + `2002_M_survey2017`]
poly.sa.habitat [year == 2017, mpb_s_15_year_area_ha := `2016_S_survey2017` +   `2012_S_survey2017` + `2010_S_survey2017` + `2009_S_survey2017` + `2008_S_survey2017` + `2007_S_survey2017` + `2006_S_survey2017` + `2005_S_survey2017` + `2004_S_survey2017` + `2003_S_survey2017` + `2002_S_survey2017`] # no data `2015_S_survey2017` +`2014_S_survey2017` +  `2013_S_survey2017` + `2011_S_survey2017` + 
poly.sa.habitat [year == 2017, mpb_vs_15_year_area_ha :=    `2011_V_survey2017` +  `2009_V_survey2017` + `2008_V_survey2017` + `2007_V_survey2017` + `2006_V_survey2017` + `2005_V_survey2017` + `2004_V_survey2017` + `2003_V_survey2017` ] # no data `2016_V_survey2017` + `2015_V_survey2017` + `2014_V_survey2017` + `2013_V_survey2017` +  `2012_V_survey2017` + `2010_V_survey2017` + `2002_V_survey2017`

poly.sa.habitat [year == 2018, mpb_m_15_year_area_ha := `2017_M_survey2018` + `2016_M_survey2018` + `2015_M_survey2018` + `2014_M_survey2018` + `2013_M_survey2018` + `2012_M_survey2018` + `2011_M_survey2018` + `2010_M_survey2018` + `2009_M_survey2018` + `2008_M_survey2018` + `2007_M_survey2018` + `2006_M_survey2018` + `2005_M_survey2018` + `2004_M_survey2018` + `2003_M_survey2018`]
poly.sa.habitat [year == 2018, mpb_s_15_year_area_ha := `2017_S_survey2018` + `2016_S_survey2018` +   `2012_S_survey2018` +  `2010_S_survey2018` + `2009_S_survey2018` + `2008_S_survey2018` + `2007_S_survey2018` + `2006_S_survey2018` + `2005_S_survey2018` + `2004_S_survey2018` + `2003_S_survey2018`] # no data `2015_S_survey2018` + `2014_S_survey2018` + `2013_S_survey2018` + `2011_S_survey2018` +
poly.sa.habitat [year == 2018, mpb_vs_15_year_area_ha := `2011_V_survey2018` +  `2009_V_survey2018` + `2008_V_survey2018` + `2007_V_survey2018` + `2006_V_survey2018` + `2005_V_survey2018` + `2004_V_survey2018` + `2003_V_survey2018`] # no data `2017_V_survey2018` + `2016_V_survey2018` +  `2015_V_survey2018` + `2014_V_survey2018` + `2013_V_survey2018` + `2012_V_survey2018` + `2010_V_survey2018` +

# 15 year cumulative mod, severe and very severe
poly.sa.habitat [, mpb_all_15_year_area_ha := mpb_m_15_year_area_ha + mpb_s_15_year_area_ha + mpb_vs_15_year_area_ha]

# 15 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_25_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha + cut_1990_area_ha]
poly.sa.habitat [year == 2015, cut_25_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha] 
poly.sa.habitat [year == 2017, cut_25_year_area_ha := cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha] 
poly.sa.habitat [year == 2017, cut_25_year_area_ha := cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha] 
poly.sa.habitat [year == 2018, cut_25_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha] 

write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

poly.sa.habitat.sum <- poly.sa.habitat [, .(unique_id, id, year, name_sa, area_ha, cut_8_year_area_ha, cut_15_year_area_ha, cut_25_year_area_ha, mpb_all_8_year_area_ha, mpb_all_15_year_area_ha, mpb_m_8_year_area_ha, mpb_s_8_year_area_ha, mpb_vs_8_year_area_ha, mpb_m_15_year_area_ha, mpb_s_15_year_area_ha, mpb_vs_15_year_area_ha)]

write.csv (poly.sa.habitat.sum, here ("./data/study_area_habitat_sum.csv"))

```

### Population Parameters
- dependent variables are:
    - annual survival rate, human and all mortality types?
    - change in annual survival rate, human and all mortality types?
    - change in density 

```{r population params table, echo = T, message = F, warning = F}

table.pop.data = data.table(
  unique_id = c ("Big Creek2015", "Big Creek2016", "Big Creek2017", "Big Creek2018", "Bonaparte2015",
                 "Bonaparte2016", "Bonaparte2017", "Bonaparte2018", "Entiako2014", "Entiako2015", 
                 "Entiako2016", "Entiako2017", "Entiako2018", "John Prince Research Forest2015",
                 "John Prince Research Forest2016", "John Prince Research Forest2017",
                 "John Prince Research Forest2018", "Prince George South2015", 
                 "Prince George South2016", "Prince George South2017", "Prince George South2018"),
  af_survival_rate_all = c (0.923, 0.862, 0.897, 0.901, 0.912, 0.871, 0.906, 0.977, 0.970, 0.913,
                            0.799, 0.775, 0.817, 1, 0.923, 0.949, 0.951, 0.875, 0.842, 0.946, 0.794),
  af_survival_rate_all_95CI = c (0.085, 0.103, 0.143, 0.092, 0.130, 0.092, 0.124, 0.045, NA, 0.081, 
                                 0.111, 0.168, 0.133, 0, 0.084, 0.110, 0.066, 0.162, 0.118, 0.151, 
                                 0.122),
  calves_100cows = c(37, 33, 27, 32, 25, 26, 16, 38, NA, NA, 14, 9, 15, 8, 17, 40, 37, 39, 27, 40,
                     26),
  density = c(170, NA, NA, 220, 296, NA, NA, 254, NA, 267, NA, NA, 217, 770, NA, NA, 490, 630, NA, 
              NA, 400),
  density_95CI = c(39, NA, NA, 38, 18, NA, NA, 41, NA, 45, NA, NA, 46, 93, NA, NA, 84, 102, NA, NA, 
                   78)
)

# link pop table to habitat table
setkey (table.pop.data, unique_id)
setkey (poly.sa.habitat.sum, unique_id)
data <- merge (table.pop.data, poly.sa.habitat.sum, all.x = TRUE)

# convert areas to proportion of study area
data [, prop_cut_8_year_area_ha := cut_8_year_area_ha / area_ha]
data [, prop_cut_15_year_area_ha := cut_15_year_area_ha / area_ha]
data [, prop_cut_25_year_area_ha := cut_25_year_area_ha / area_ha]
data [, prop_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha / area_ha]
data [, prop_mpb_m_15_year_area_ha := mpb_m_15_year_area_ha / area_ha]
data [, prop_mpb_s_8_year_area_ha := mpb_s_8_year_area_ha / area_ha]
data [, prop_mpb_s_15_year_area_ha := mpb_s_15_year_area_ha / area_ha]
data [, prop_mpb_vs_8_year_area_ha := mpb_vs_8_year_area_ha / area_ha]
data [, prop_mpb_vs_15_year_area_ha := mpb_vs_15_year_area_ha / area_ha]
data [, prop_mpb_all_8_year_area_ha := mpb_all_8_year_area_ha / area_ha]
data [, prop_mpb_all_15_year_area_ha := mpb_all_15_year_area_ha / area_ha]

# get change in values for comapring rates of change
data [, delta_af_survival_rate_all := af_survival_rate_all - shift (af_survival_rate_all, n = 1, type = "lag"), by = name_sa]
data [, delta_calves_100cows := calves_100cows - shift (calves_100cows, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_8_year_area_ha := cut_8_year_area_ha - shift (cut_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_15_year_area_ha := cut_15_year_area_ha - shift (cut_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_25_year_area_ha := cut_25_year_area_ha - shift (cut_25_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha - shift (mpb_m_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_s_8_year_area_ha := mpb_s_8_year_area_ha - shift (mpb_s_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_vs_8_year_area_ha := mpb_vs_8_year_area_ha - shift (mpb_vs_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_all_8_year_area_ha := mpb_all_8_year_area_ha - shift (mpb_all_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_m_15_year_area_ha := mpb_m_15_year_area_ha - shift (mpb_m_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_s_15_year_area_ha := mpb_s_15_year_area_ha - shift (mpb_s_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_vs_15_year_area_ha := mpb_vs_15_year_area_ha - shift (mpb_vs_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_all_15_year_area_ha := mpb_all_15_year_area_ha - shift (mpb_all_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_8_year_area_ha := prop_cut_8_year_area_ha - shift (prop_cut_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_15_year_area_ha := prop_cut_15_year_area_ha - shift (prop_cut_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_25_year_area_ha := prop_cut_25_year_area_ha - shift (prop_cut_25_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_m_8_year_area_ha := prop_mpb_m_8_year_area_ha - shift (prop_mpb_m_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_m_15_year_area_ha := prop_mpb_m_15_year_area_ha - shift (prop_mpb_m_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_s_8_year_area_ha := prop_mpb_s_8_year_area_ha - shift (prop_mpb_s_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_s_15_year_area_ha := prop_mpb_s_15_year_area_ha - shift (prop_mpb_s_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_vs_8_year_area_ha := prop_mpb_vs_8_year_area_ha - shift (prop_mpb_vs_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_vs_15_year_area_ha := prop_mpb_vs_15_year_area_ha - shift (prop_mpb_vs_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_all_8_year_area_ha := prop_mpb_all_8_year_area_ha - shift (prop_mpb_all_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_all_15_year_area_ha := prop_mpb_all_15_year_area_ha - shift (prop_mpb_all_15_year_area_ha, n = 1, type = "lag"), by = name_sa]

data [is.na (data)] <- 0

write.csv (data, here ("./data/data.csv"))
```


### Descriptive Stats and Visualization
- look at distribtuion of data 

#### Cutblocks
- estimated total area of cutblocks less than 8 years old in each study area versus estimated survival rate
  - negative relationship in Entiako and JPRF
  - positive in Big Creek and PG South
  - flat in Bonaparte
  - defintely no consistent response here

```{r, total area cut <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (cut_8_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Total Area of Cutblocks <8 years old in 
the Study Area MCPs",
        x = "Total Area of Cutblocks <8 years old (km2)",
        y = "Adult Female Moose Survival Rate") 
```

- what about proportion?
  - not any better...

```{r, proportion area cut <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (prop_cut_8_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Percent of Area that is 
Cutblocks <8 years old in the Study Area MCPs",
        x = "Percent of Area that is Cutblocks <8 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

- if we consider a longer time-frame, 15 years?
  - nope....

```{r, total area cut <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (cut_15_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Total Area of Cutblocks <8 years old in 
the Study Area MCPs",
        x = "Total Area of Cutblocks <15 years old (km2)",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45)) 
```

- proprotion?
 - suggests the oppostie effect...

```{r, proportion area cut <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (prop_cut_15_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Percent of Area that is 
Cutblocks <15 years old in the Study Area MCPs",
        x = "Percent of Area that is Cutblocks <15 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```


- consider rate of change over time
  - again, no clear pattern here

```{r, change in proportion area cut <8 years old x survival rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (delta_prop_cut_8_year_area_ha*100), 
                   y = delta_af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Change in Adult Female Moose Survival Rate by Chnage in Percent of Area that 
is Cutblocks <8 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Cutblocks <8 years old",
        y = "Change in Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```


- calves


#### MPB

- 




















```{r exploratory stats and data vis, echo = T, message = F, warning = F}


  








### OUTLIERS ###
ggplot (data, aes (x = pttype, y = slope)) +
        geom_boxplot (outlier.colour = "red") +
        labs (title = "Boxplot DU7, Early Winter Slope at Available (0) and Used (1) Locations",
              x = "Available (0) and Used (1) Locations",
              y = "Slope")



### HISTOGRAMS ###
ggplot (rsf.data.terrain.water.du7.ew, aes (x = slope, fill = pttype)) + 
          geom_histogram (position = "dodge", binwidth = 5) +
          labs (title = "Histogram DU7, Early Winter Slope at Available (0) and Used (1) Locations",
                x = "Slope",
                y = "Count") +
          scale_fill_discrete (name = "Location Type")


### CORRELATION ###
corr.terrain.water.du7.ew <- rsf.data.terrain.water.du7.ew [c (10:15)]
corr.terrain.water.du7.ew <- round (cor (corr.terrain.water.du7.ew, method = "spearman"), 3)
ggcorrplot (corr.terrain.water.du7.ew, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Terrain and Water Resource Selection Function Model
            Covariate Correlations for DU7, Early Winter")
ggsave ("C:\\Work\\caribou\\clus_github\\reports\\caribou_rsf\\plots\\corr_terrain_water_du7_ew.png")



```



### Model


