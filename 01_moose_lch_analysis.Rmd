---
title: "Moose Landcape Change Hypothesis Analysis"
author: "Tyler Muhly"
date: "04/15/2020"
output: 
  html_document:
  keep_md: yes
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (data.table)
library (downloader)
library (dplyr)
library (ggplot2)
library (here)
library (lwgeom)
library (sf)
library (kableExtra)
library (nlme) 
library (lattice)

```

## Introduction
Here I document how I estimated landscape metrics to explore the moose 'landscape change hypothesis' (LCH). The moose LCH posits that recent moose population declines in parts of central British Columbia (BC) were related to large-scale changes to forest cover (i.e., landscape disturbance), caused by an extensive mountain pine beetle (MPB) infestation and subsequent forest harvest to salvage MPB killed forest stands. The LCH predicts a negative relationship between the amount of landscape disturbance and adult female moose survival. This relationship is indicative that processes related to landscape disturbance, i.e., reduced amount of security and thermal cover and increased amounts of negative interactions with humans (e.g., hunting mortality) due to higher road densities cause moose population declines. As a preliminary test of the LCH, here I use a mixed effects regression model to relate estimates of forest disturbance from MPB and forestry (cutblocks) to estimates of adult female moose survival in five study areas. 

## Methods
### Study Areas
The LCH was tested by sampling moose survival rates in the Big Creek, Bonaparte, Entiako, John Prince Research Forest (JPRF) and Prince George South study areas. These five study areas were selected because they had varied levels of MPB and forestry disturbance. A sample of moose in each study area were captured annually and collared with global positioning system (GPS) telemetry collars. Annual moose study area boundaries were determined by calculating the 100% minimum convex polygon (MCP) of annual sampled adult female moose GPS locations in each area. Moose locations were collected for four years from 2015 to 2018 (except Entiako, where data was also collected in 2014), and thus study area boundaries were re-calculated for each of these years. Each study area can be considered as a landscape 'treatment', and each were sampled annually for a four or five year period.    

```{r, management unit spatial data, eval = F, echo = F, message = F, warning = F, include = F}
# load the mcp's
poly.sa.bc.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2014_15_MCP"), 
                         crs = 3005) # setting these all to the same coordinate system
poly.sa.bc.14.15$year <- 2015 # add year
poly.sa.bc.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2015_16_MCP"), 
                         crs = 3005)
poly.sa.bc.15.16$year <- 2016 # add year
poly.sa.bc.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2016_17_MCP"), 
                         crs = 3005)
poly.sa.bc.16.17$year <- 2017 # add year
poly.sa.bc.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2017_18_MCP"), 
                         crs = 3005)
poly.sa.bc.17.18$year <- 2018 # add year
poly.sa.jprf.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2014_15_MCP"), 
                         crs = 3005)
poly.sa.jprf.14.15$year <- 2015 
poly.sa.jprf.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2015_16_MCP"), 
                         crs = 3005)
poly.sa.jprf.15.16$year <- 2016 
poly.sa.jprf.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2016_17_MCP"), 
                         crs = 3005)
poly.sa.jprf.16.17$year <- 2017
poly.sa.jprf.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2017_18_MCP"), 
                         crs = 3005)
poly.sa.jprf.17.18$year <- 2018
poly.sa.pgs.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2014_15_MCP"), 
                         crs = 3005)
poly.sa.pgs.14.15$year <- 2015
poly.sa.pgs.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2015_16_MCP"), 
                         crs = 3005)
poly.sa.pgs.15.16$year <- 2016
poly.sa.pgs.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2016_17_MCP"), 
                         crs = 3005)
poly.sa.pgs.16.17$year <- 2017
poly.sa.pgs.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2017_18_MCP"), 
                         crs = 3005)  
poly.sa.pgs.17.18$year <- 2018
poly.sa.bon.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon14_15MCP.shp")), 
                         crs = 3005)
poly.sa.bon.14.15$year <- 2015
poly.sa.bon.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon15_16MCP.shp")), 
                         crs = 3005)
poly.sa.bon.15.16$year <- 2016
poly.sa.bon.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon16_17MCP.shp")), 
                         crs = 3005)
poly.sa.bon.16.17$year <- 2017
poly.sa.bon.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon17_18MCP.shp")), 
                         crs = 3005)
poly.sa.bon.17.18$year <- 2018
poly.sa.entiako.13.14 <- st_transform (st_read (dsn = here ( "./data/mcp/entiako_revised_mcps/mdata13.mcp100.shp")), 
                         crs = 3005)
poly.sa.entiako.13.14$year <- 2014
poly.sa.entiako.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/entiako_revised_mcps/mdata14.mcp100.shp")), 
                         crs = 3005)
poly.sa.entiako.14.15$year <- 2015
poly.sa.entiako.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/entiako_revised_mcps/mdata15.mcp100.v2.shp")), 
                         crs = 3005)
poly.sa.entiako.15.16$year <- 2016
poly.sa.entiako.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/entiako_revised_mcps/mdata16.mcp100.shp")), 
                         crs = 3005)
poly.sa.entiako.16.17$year <- 2017
poly.sa.entiako.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/entiako_revised_mcps/mdata17.mcp100.shp")), 
                         crs = 3005)
poly.sa.entiako.17.18$year <- 2018

# bind them up by area, add area names adn make fields consistent
# Big Creek
poly.sa.bc <- rbind (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
poly.sa.bc$name_sa <- "Big Creek"
poly.sa.bc$area_ha <- poly.sa.bc$area * 0.0001
poly.sa.bc$Shape_Length <- NULL
poly.sa.bc$Shape_Area <- NULL
poly.sa.bc$area <- NULL
poly.sa.bc$id <- 1
names(poly.sa.bc)[names(poly.sa.bc) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.bc) <- "geometry"
rm (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
gc ()

# John Prince Research Forest
poly.sa.jprf <- rbind (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
names(poly.sa.jprf)[names(poly.sa.jprf) == "Id"] = "id" # rename the Id column
poly.sa.jprf$id <- 2
poly.sa.jprf$area_ha <- (st_area (poly.sa.jprf$Shape) * 0.0001) # area needs to be calc'd
poly.sa.jprf$name_sa <- "John Prince Research Forest"
poly.sa.jprf$Shape_Length <- NULL
poly.sa.jprf$Shape_Area <- NULL
names(poly.sa.jprf)[names(poly.sa.jprf) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.jprf) <- "geometry"
rm (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
gc ()

# Prince George South
poly.sa.pgs <- rbind (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
names(poly.sa.pgs)[names(poly.sa.pgs) == "Id"] = "id" 
poly.sa.pgs$id <- 3
poly.sa.pgs$area_ha <- (st_area (poly.sa.pgs$Shape) * 0.0001)
poly.sa.pgs$name_sa <- "Prince George South"
poly.sa.pgs$Shape_Length <- NULL
poly.sa.pgs$Shape_Area <- NULL
names(poly.sa.pgs)[names(poly.sa.pgs) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.pgs) <- "geometry"
rm (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
gc ()

# Bonaparte
poly.sa.bon <- rbind (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
names(poly.sa.bon)[names(poly.sa.bon) == "Id"] = "id" 
poly.sa.bon$id <- 4
poly.sa.bon$area_ha <- (st_area (poly.sa.bon$geometry) * 0.0001)
poly.sa.bon$name_sa <- "Bonaparte"
rm (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
gc ()

# Entiako
poly.sa.entiako <- rbind (poly.sa.entiako.13.14, poly.sa.entiako.14.15, poly.sa.entiako.15.16, poly.sa.entiako.16.17, poly.sa.entiako.17.18)
poly.sa.entiako$id <- 5
poly.sa.entiako$area_ha <- poly.sa.entiako$area
poly.sa.entiako$area <- NULL
poly.sa.entiako$name_sa <- "Entiako"
rm (poly.sa.entiako.13.14, poly.sa.entiako.14.15, poly.sa.entiako.15.16, poly.sa.entiako.16.17, poly.sa.entiako.17.18)
gc ()

# all together now...
poly.sa <- rbind (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
rm (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
gc ()

# unique identifier for each
poly.sa$unique_id <- with (poly.sa, paste0 (as.character (name_sa), as.character (year)))

# save it 
st_write (poly.sa, 
          dsn = here ("./data/mcp/"), 
          layer = "study_area_mcp_moose", 
          driver = "ESRI Shapefile")
```

### Population Data
Adult female moose survival rates were estimated annually from mortality data collected from the sampled animals. Survival was estimated for a biological year, i.e., April to April(?), not a calendar year. Thus, for example, a survival estimate for 2015 was calculated using mortality data collected from April 2014 to April 2015. 

### Estimating Area of Cutblocks in Study Areas
I estimated the area of less than 9 year old forestry cutblocks and MPB disturbed stands in each study area. I estimated the area of cutblocks using the [consolidated cutblocks](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-) dataset for BC. I intersected this data with the study area boundaries and then summarized the area cut by year from 2006 to 2018. I then calculated the area of cutblocks less than 9 years old for each study area year to align with adult female moose survival estimates for that year. For example, for survival estimates calculated for year 2015, I calculated the area cut from 2008 to 2015 as an estimate of area cut less than 9 years old. Thus, the assumption was the majority of area was cut early in a calendar year, during the period which survival estimates were calculated. 

```{r, cutblock data download and attribute to study areas, eval = F, echo = T, message = F, warning = F, include = F}

# library (bcdata) # use this to conenct to bcgw via R
# cutblocks <- bcdc_get_data ('b1b647a6-f271-42e0-9cd0-89ec24bce9f7', resource = '66656966-8af6-4e32-8de1-b79c63cae40f') # name of the data in BCGW; I noticed there are 413451 rows form here, whereas 446,987 in the BCGW; not sure why they are different, but this version likely underestimates the area of cutblocks; so I used the BCGW data and imported it here...
cutblocks <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\moose_lch.gdb",
                          layer = "cutblocks_20191217")
cutblocks <- lwgeom::st_make_valid (cutblocks) # fix any geometry errors

# intersect cutblocks with study area values
sa.cutblocks <- sf::st_intersection (cutblocks, poly.sa ["unique_id"]) # intersect the study area ID
table.sa.cutblocks <- as.data.table (sa.cutblocks)

# summarize cut by study area
table.sa.cutblocks.mum <- table.sa.cutblocks %>% 
                             group_by (unique_id, HARVEST_YEAR) %>%
                             summarise (area_ha = sum (AREA_HA)) # calculate area of cut by year

# get study area id
poly.sa.habitat <- as.data.table (poly.sa)
poly.sa.habitat$geometry <- NULL

## these next steps left-join the cutblock data to wmu data ##
### Subset the harvest years ###
#### 2000 to 2018 ####
fxn.cut.year <- function (year, table.sa.cutblocks.mum, poly.sa.habitat) {
  table <- as.data.table (table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR == year, ])
  table [, paste0 ("cut_", year, "_area_ha") := area_ha] 
  table$area_ha <- NULL
  table$HARVEST_YEAR <- NULL
  setkey (table, unique_id)
  setkey (poly.sa.habitat, unique_id)
  poly.sa.habitat <- merge (poly.sa.habitat, table, all.x = TRUE)
  poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
  poly.sa.habitat <<- poly.sa.habitat
}

year <- 2018
fxn.cut.year (year, table.sa.cutblocks.mum, poly.sa.habitat)
  
# 8 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_8_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha]
poly.sa.habitat [year == 2015, cut_8_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha] #where year = 2015
poly.sa.habitat [year == 2016, cut_8_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha] #where year = 2016
poly.sa.habitat [year == 2017, cut_8_year_area_ha := cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha] 
poly.sa.habitat [year == 2018, cut_8_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha] 

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

rm (cutblocks, table.sa.cutblocks, table.sa.cutblocks.mum, sa.cutblocks)
gc ()
```

### Estimating Area of Mountain Pine Beetle Disturbed Stands in Study Areas
I estimated the area of forest stands disturbed by mountain pine beetle in each study area using data collected from [annual aerial surveys](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/forest-health/aerial-overview-surveys/methods) by the government of BC. These data were accessible through an [FTP site](https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/), and I downloaded annual datasets from 1999 to 2018.  I summarized the area of moderately (11 to 29%), severely (30 to 49%) and very severely (>50%) disturbed forest stands for each year. Estimates cannot be added cumulatively each year, as damage to stands measured in previous years may be updated with new data from subsequent years. Thus, I ensured that spatially overlapping stands were updated using ArcGIS. I also deleted any areas that overlapped with cutblocks less than or equal to eight years old to avoid double-counting total disturbance where these types overlapped. I then calculated the area of MPB disturbed stands less than 9 years old for each study area year to align with adult female moose survival estimates for that year. MPB surveys were typically completed in July-August, thus, for example, for survival estimates calculated for year 2015, I calculated the area of MPB disturbed stands from 2008 to 2015 as an estimate of area of MPB stands less than 9 years old. 

```{r, forest health data download and attribute beetle disturbance to study areas, echo = T, message = F, warning = F, eval = F, include = F}

# Download data; this is an example; do these for each year and save it locally
download ("https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/1999/shape/Prov_Shape.zip", 
            dest = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
            mode = "wb")
unzip ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
       exdir = "C:\\Work\\caribou\\clus_data\\forest_health\\1999")
file.remove ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip")

#########################################################
# Determine MPB affected stands by year - 1998 to 2008 #
#######################################################
#------------------------------------------------------
# I found that MPB data wasn't updated annualy, e.g., a surveyed stand in 1998 
# may not necessarily be re-surveyd in 1999. So, I had to 'erase' current years data from previous years data (cumulative), and then merge that with the cumulative mpb disturbance to date
### in R, but it TOOK AWHILE, SO I DID THE GIS PROCESSING IN ARCGIS ###

# do the analysis using the data processed in ArcGIS
  # clipped to study area
  # unioned with study area
  # area in ha calc (POLY_AREA)
  # erase new years data from previous year's cumulative data
  # merge new years data to cumulative data
  # for each year, erase cutblocks from previous 8 years

# function to load and overlay mpb data by year and study area 

fxn.mpb.summary <- function (dsn, survey.year, poly.sa.habitat) {
fh <- sf::st_read (dsn = paste0 (dsn))
mpb <- fh %>%
        filter(FHF == "IBM") %>%
        filter (SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")
table <- as.data.table (mpb)  
table$survey.year <- paste0 (survey.year)
table.cast <- as.data.table (dcast (table, 
                                    unique_id ~ YEAR_1 + SEVERITY + survey.year, 
                                    value.var = "POLY_AREA",  
                                    fun = sum))
setkey (table.cast, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.cast, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0
poly.sa.habitat <<- poly.sa.habitat
}


fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2014_cumul_v2.shp", 
 "survey2014", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2015_cumul_v2.shp", 
  "survey2015", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2016_cumul_v2.shp", 
  "survey2016", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2017_cumul_v2.shp", 
  "survey2017", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2018_cumul_v2.shp", 
  "survey2018", 
   poly.sa.habitat)

# severity types: very severe (>50% of Trees in Polygon Recently Killed), severe (30% to 49%), moderate (11% to 29%)

# Cumulative mpb  
### NOTE: for MPB, each year survey is cumulative, impact of previous years are included in last year, so use last survey year 
poly.sa.habitat [year == 2014, mpb_m_8_year_area_ha_2014 := `2014_M_survey2014` + `2013_M_survey2014` + `2012_M_survey2014` + `2011_M_survey2014` + `2010_M_survey2014` + `2009_M_survey2014` + `2008_M_survey2014` + `2007_M_survey2014`]
poly.sa.habitat [year == 2014, mpb_s_8_year_area_ha_2014 :=    `2012_S_survey2014` + `2010_S_survey2014` + `2009_S_survey2014` + `2008_S_survey2014` + `2007_S_survey2014` ] # no data   `2014_S_survey2014` +  `2013_S_survey2014` + `2011_S_survey2014`  + 
poly.sa.habitat [year == 2014, mpb_vs_8_year_area_ha_2014 :=    `2011_V_survey2014` +   `2009_V_survey2014` + `2008_V_survey2014` + `2007_V_survey2014`] # no data   `2014_V_survey2014` + `2013_V_survey2014` + `2012_V_survey2014` + `2010_V_survey2014` +

poly.sa.habitat [year == 2015, mpb_m_8_year_area_ha_2015 := `2015_M_survey2015` + `2014_M_survey2015` + `2013_M_survey2015` + `2012_M_survey2015` + `2011_M_survey2015` + `2010_M_survey2015` + `2009_M_survey2015` + `2008_M_survey2015`]
poly.sa.habitat [year == 2015, mpb_s_8_year_area_ha_2015 :=  `2012_S_survey2015` + `2010_S_survey2015` + `2009_S_survey2015` + `2008_S_survey2015`] # no data `2015_S_survey2015` +  `2014_S_survey2015` + `2013_S_survey2015` + `2011_S_survey2015` + 
poly.sa.habitat [year == 2015, mpb_vs_8_year_area_ha_2015 :=    `2011_V_survey2015` +  `2009_V_survey2015` + `2008_V_survey2015`] # no data `2015_V_survey2015` +  `2014_V_survey2015` +  `2013_V_survey2015` + `2012_V_survey2015` + `2010_V_survey2015` + 

poly.sa.habitat [year == 2016, mpb_m_8_year_area_ha_2016 := `2016_M_survey2016` + `2015_M_survey2016` + `2014_M_survey2016` + `2013_M_survey2016` + `2012_M_survey2016` + `2011_M_survey2016` + `2010_M_survey2016` + `2009_M_survey2016`]
poly.sa.habitat [year == 2016, mpb_s_8_year_area_ha_2016 :=  `2016_S_survey2016` +   `2012_S_survey2016` +  `2010_S_survey2016` + `2009_S_survey2016`] # no data  `2015_S_survey2016` + `2014_S_survey2016` + `2013_S_survey2016` +  `2011_S_survey2016` +
poly.sa.habitat [year == 2016, mpb_vs_8_year_area_ha_2016 := `2011_V_survey2016` +  `2009_V_survey2016`] # no data  `2016_V_survey2016` + `2015_V_survey2016` + `2014_V_survey2016` + `2013_V_survey2016` +  `2012_V_survey2016` + `2010_V_survey2016` + 

poly.sa.habitat [year == 2017, mpb_m_8_year_area_ha_2017 := `2017_M_survey2017` + `2016_M_survey2017` + `2015_M_survey2017` + `2014_M_survey2017` + `2013_M_survey2017` + `2012_M_survey2017` + `2011_M_survey2017` + `2010_M_survey2017`]
poly.sa.habitat [year == 2017, mpb_s_8_year_area_ha_2017 :=  `2017_S_survey2017` +  `2016_S_survey2017` +   `2012_S_survey2017` +   `2010_S_survey2017`] # no data  `2015_S_survey2017` + `2014_S_survey2017` + `2013_S_survey2017` + `2011_S_survey2017` +
poly.sa.habitat [year == 2017, mpb_vs_8_year_area_ha_2017 :=  `2011_V_survey2017` ] # no data  `2017_V_survey2017` + `2016_V_survey2017` + `2015_V_survey2017` +  `2014_V_survey2017` + `2013_V_survey2017` + `2012_V_survey2017`+ `2010_V_survey2017`

poly.sa.habitat [year == 2018, mpb_m_8_year_area_ha_2018 := `2018_M_survey2018` + `2017_M_survey2018` + `2016_M_survey2018` + `2015_M_survey2018` + `2014_M_survey2018` + `2013_M_survey2018` + `2012_M_survey2018` + `2011_M_survey2018`]
poly.sa.habitat [year == 2018, mpb_s_8_year_area_ha_2018 :=  `2018_S_survey2018` + `2017_S_survey2018` + `2016_S_survey2018` + `2012_S_survey2018`] # no data  `2015_S_survey2018` + `2014_S_survey2018` + `2013_S_survey2018` + `2011_S_survey2018` +  
poly.sa.habitat [year == 2018, mpb_vs_8_year_area_ha_2018 :=   `2011_V_survey2018` ] # no data  `2018_V_survey2018` + `2017_V_survey2018` + `2016_V_survey2018` + `2015_V_survey2018` + `2014_V_survey2018` +  `2013_V_survey2018` + `2012_V_survey2018`+

poly.sa.habitat[is.na(poly.sa.habitat)] <- 0

poly.sa.habitat [, mpb_m_8_year_area_ha :=   `mpb_m_8_year_area_ha_2014` + `mpb_m_8_year_area_ha_2015` + `mpb_m_8_year_area_ha_2016` +  `mpb_m_8_year_area_ha_2017` + `mpb_m_8_year_area_ha_2018`]
poly.sa.habitat [, mpb_s_8_year_area_ha :=   `mpb_s_8_year_area_ha_2014` + `mpb_s_8_year_area_ha_2015` + `mpb_s_8_year_area_ha_2016` +  `mpb_s_8_year_area_ha_2017` + `mpb_s_8_year_area_ha_2018`]
poly.sa.habitat [, mpb_vs_8_year_area_ha :=   `mpb_vs_8_year_area_ha_2014` + `mpb_vs_8_year_area_ha_2015` + `mpb_vs_8_year_area_ha_2016` +  `mpb_vs_8_year_area_ha_2017` + `mpb_vs_8_year_area_ha_2018`]

poly.sa.habitat [, mpb_all_8_year_area_ha :=   `mpb_m_8_year_area_ha` + `mpb_s_8_year_area_ha` + `mpb_vs_8_year_area_ha`]


poly.sa.habitat.sum <- poly.sa.habitat %>%
                        select (unique_id,	id,	year,	name_sa,	area_ha,	cut_8_year_area_ha,	mpb_all_8_year_area_ha,	
                                mpb_m_8_year_area_ha,	mpb_s_8_year_area_ha,	mpb_vs_8_year_area_ha)

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))
write.csv (poly.sa.habitat.sum, here ("./data/study_area_habitat_sum.csv"))

```

### Estimating Population Parameters
- currently using data provided in Doug's spreadsheet
- dependent variables are currently:
    - annual adult female survival rate
      - total
      - hunting
      - wolf

```{r population params table, echo = F, message = F, warning = F, eval = T}
table.pop.data = data.table(
  unique_id = c ("Big Creek2015", "Big Creek2016", "Big Creek2017", "Big Creek2018", "Bonaparte2015",
                 "Bonaparte2016", "Bonaparte2017", "Bonaparte2018", "Entiako2015", 
                 "Entiako2016", "Entiako2017", "Entiako2018", "John Prince Research Forest2016", 
                 "John Prince Research Forest2017",
                 "John Prince Research Forest2018", "Prince George South2015", 
                 "Prince George South2016", "Prince George South2017", "Prince George South2018"),
  af_survival_rate_all = c (0.923, 0.862, 0.897, 0.901, 0.978, 0.917, 0.938, 0.982, 0.913, 0.818, 0.756, 0.818, 0.923, 0.949, 0.950, 0.933, 0.842, 0.946, 0.768),
  af_survival_rate_hunt = c (0.970, 0.975, 0.974, 0.951, NA, 0.955, 0.985, 0.982, NA, NA, NA, NA, NA, NA, 0.975, NA, 0.968, 0.974, NA),
  af_survival_rate_wolf = c (0.953, 0.953, 0.949, 0.951, NA, NA, 0.969, NA, 0.959, 0.879, 0.828, 0.937, 0.949, 0.976, NA, NA, 0.968, 0.972, 0.873)
)

kable (table.pop.data,
       caption = "<b>Table 1. Moose Population Parameter Estimates.<b>",
       col.names = c("Study Area",
                     "Adult Female Survival Rate (all mortality factors)",
                      "Adult Female Survival Rate (hunting mortality only)",
                      "Adult Female Survival Rate (wolf mortality only)")) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

```{r, link pop params to habitat covariates, echo = F, message = F, warning = F, eval = F, include = F}

# link pop table to habitat table
setkey (table.pop.data, unique_id)
setkey (poly.sa.habitat.sum, unique_id)
data <- merge (table.pop.data, poly.sa.habitat.sum, all.x = TRUE)

# convert areas to proportion of study area
data [, prop_cut_8_year_area_ha := cut_8_year_area_ha / area_ha]
data [, prop_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha / area_ha]
data [, prop_mpb_s_8_year_area_ha := mpb_s_8_year_area_ha / area_ha]
data [, prop_mpb_vs_8_year_area_ha := mpb_vs_8_year_area_ha / area_ha]
data [, prop_mpb_all_8_year_area_ha := mpb_all_8_year_area_ha / area_ha]

data [is.na (data)] <- 0

write.csv (data, here ("./data/data.csv"))
```

### Mixed Effects Model of Relationship Between Adult Female Moose Survival and Habitat
We wanted to test the effect of landscape disturbance on moose survival across the interior of BC (i.e., the 'population-level' effect), and we repeteadly sampled moose in specific landscapes (i.e., study area 'subjects') with different levels of disturbance (i.e., treatments). To correctly assess the population-level effect of disturbance, we needed to account for repeated sampling of subjects in our regression model. Thus, we used a mixed effects regression model that included a random effect intercept for each study area to account for the fact that each study area had unique disturbance levels, and an autocorrelation structure with a lag of 1 (AR1), which fits the model accounting for the fact that samples from the same study area are correlated with each other. These models were fit using the [nlme](https://cran.r-project.org/web/packages/nlme/nlme.pdf) pacakge in program R.

## Preliminary Results
Here I provide a preliminary description of the relationship between estimates of landscape disturbance and moose adult female survival. Entiako was typically the largest study area, at approximately 1,000,000 ha, and Bonaparte was typically the smallest study area, at approximately 320,000 ha (Table 2). The JPRF study area had typically the highest amount of less than 9 year old cutblocks. The Big Creek study area typically had the highest amount of less than 9 year old MPB disturbed forest stands.

```{r, table of disturbance by study area, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
data.disturb.summary <- data %>%
                          select (name_sa, year, area_ha, cut_8_year_area_ha, mpb_all_8_year_area_ha)
data.disturb.summary <- data.disturb.summary [order (data.disturb.summary$name_sa, data.disturb.summary$year), ]

data.disturb.summary$cut_8_year_area_ha <- round (data.disturb.summary$cut_8_year_area_ha, digits = 0)
data.disturb.summary$mpb_all_8_year_area_ha <- round (data.disturb.summary$mpb_all_8_year_area_ha, digits = 0)
data.disturb.summary$area_ha <- round (data.disturb.summary$area_ha, digits = 0)
data.disturb.summary$year <- as.character(data.disturb.summary$year)
  
kable (data.disturb.summary,
       caption = "<b>Table 2. Summary of Cutblock and Mountain Pine Beetle Disturbance Area by Study Area and Year.<b>",
       col.names = c("Study Area",
                     "Year",
                     "Area (ha)",
                      "Area of Cutblocks Less Than 8 y.o. (ha)",
                     "Area of MPB Disturbed Stands Less Than 8 y.o. (ha)"),
       format.args = list (big.mark = ",")
       ) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

Trends in adult female moose survival rates varied across the study areas from 2015 to 2018 (Fig. 1). Survival was increasing in the Bonaparte and JPRF study areas, and decreasing in the Big Creek, Entiako and Prince George South study areas. 

```{r, trend in survival over time, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
scaleFUN <- function(x) sprintf("%.0f", x) # set decimal points

ggplot (data, aes (x = year, 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 1. Trend in Adult Female Moose Survival Rate by Study Area Over Time",
        x = "Year",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45)) +
  scale_x_continuous (labels = scaleFUN)
```

### Relationship Between Cutblocks and Adult Female Moose Survival
Across the study areas, there was a positive relationship between adult female moose survival and the area of less than 9 year old cutblocks (Fig. 2). In the mixed effects model, the proportion of less than 9 year old cutblocks had a statistically significant effect on adult female moose survival (*t-value* = 4.98, *p-value* < 0.001), and each 10% increase in the percent of area of the study area that was cutblocks less than 9 years old resulted in an approximately 0.125 increase in adult female moose survival rate. 

```{r, mixed model regression area cut lt 9 yo x survival rate, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
lme.fit <- lme (af_survival_rate_all ~ prop_cut_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_cut_8_year_area_ha, 
                   y = af_survival_rate_all)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_cut_8_year_area_ha, 
                   y = predict (lme.fit, data))) +
  labs (title = "Figure 2. Adult Female Moose Survival Rate by Proportion of Area of Cutblocks 
Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Cutblocks Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

When considering only mortalities from wolves (Fig. 3), the effect of less than 9 year old cutblocks was  statistically significant (*t-value* = 2.58, *p-value* = 0.033), and each 10% increase in the percent of area of the study area that was cutblocks less than 9 years old resulted in an approximately 0.075 increase in adult female moose survival rate. 

```{r, mixed model regression area cut lt 9 yo x survival rate wolves, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
data <- data %>%
          filter (af_survival_rate_wolf > 0)# remove '0' values
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
lme.fit <- lme (af_survival_rate_wolf ~ prop_cut_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_cut_8_year_area_ha, 
                   y = af_survival_rate_wolf)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_cut_8_year_area_ha, 
                   y = predict (lme.fit, data))) +
  labs (title = "Figure 3. Adult Female Moose Survival Rate, When Considering Wolf 
Mortalities Only, by Proportion of Area of Cutblocks Less Than 9 Years Old 
in the Study Area MCPs",
        x = "Porportion Cutblocks Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate (Wolf Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 
```

When considering only mortalities from hunting (Fig. 4), the effect of less than 9 year old cutblocks was not statistically significant  (*t-value* = 0.59, *p-value* = 0.583), and the effect was close to zero. 

```{r, mixed model regression area cut lt 9 yo x survival rate hunting, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
data <- data %>%
          filter (af_survival_rate_hunt > 0)# remove '0' values
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
lme.fit <- lme (af_survival_rate_hunt ~ prop_cut_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_cut_8_year_area_ha, 
                   y = af_survival_rate_hunt)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_cut_8_year_area_ha, 
                   y = predict (lme.fit, data))) +
  labs (title = "Figure 4. Adult Female Moose Survival Rate, When Considering Hunting 
Mortalities Only, by Proportion of Area of Cutblocks Less Than 9 Years Old 
in the Study Area MCPs",
        x = "Porportion Cutblocks Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate  (Hunting Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 
```

### Relationship Between Mountain Pine Beetle Disturbance and Adult Female Moose Survival
Across the study areas, there was a weak positive relationship between adult female moose survival and the area of less than 9 year mountain pine beetle disturbed stands (Fig. 5). However, the effect was not statistically significant (*t-value* = 0.59, *p-value* = 0.564). 

```{r, mixed model regression area mpb lt 9 yo x survival rate, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
lme.fit <- lme (af_survival_rate_all ~ prop_mpb_all_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_mpb_all_8_year_area_ha, 
                   y = af_survival_rate_all)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_mpb_all_8_year_area_ha, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 5. Adult Female Moose Survival Rate by Proportion of Area of Mountain 
Pine Beetle Disturbed Stands Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Mountain Pine Beetle Disturbed Stands Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 
```

When considering only mortalities from wolves (Fig. 6), the effect of less than 9 year old cutblocks on survival was not statistically significant (*t-value* = 0.12, *p-value* = 0.836), and close to zero. 

```{r, mixed model regression area mpb lt 9 yo x survival rate wolves, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
data <- data %>%
          filter (af_survival_rate_wolf > 0) # remove '0' values
lme.fit <- lme (af_survival_rate_wolf ~ prop_mpb_all_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_mpb_all_8_year_area_ha, 
                   y = af_survival_rate_wolf)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_mpb_all_8_year_area_ha, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 6. Adult Female Moose Survival Rate, When Considering Wolf 
Mortalities Only, by Proportion of Area of Mountain Pine Beetle 
Disturbed Stands Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Mountain Pine Beetle Disturbed Stands Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate (Wolf Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

When considering only mortalities from hunting (Fig. 7), the effect of less than 9 year old cutblocks was not statistically significant (*t-value* = 0.13, *p-value* = 0.905), and close to zero. 

```{r, mixed model regression area mpb lt 9 yo x survival rate hunt, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
data <- data %>%
          filter (af_survival_rate_hunt > 0) # remove '0' values
lme.fit <- lme (af_survival_rate_hunt ~ prop_mpb_all_8_year_area_ha, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_mpb_all_8_year_area_ha, 
                   y = af_survival_rate_hunt)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_mpb_all_8_year_area_ha, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 7. Adult Female Moose Survival Rate, When Considering Hunting 
Mortalities Only, by Proportion of Area of Mountain Pine Beetle 
Disturbed Stands Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Mountain Pine Beetle Disturbed Stands Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate (Hunting Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

### Cumulative Disturbance 
I considered the relationship between adult female moose survival rate and MPB disturbed stands plus cutblocks added together (i.e., cumulative disturbance). Across the study areas, there was a positive relationship between adult female moose survival and the area of less than 9 year disturbed stands (Fig. 8). The effect was statistically significant (*t-value* = 2.51, *p-value* = 0.026), and each 10% increase in the percent of area of the study area that was less than 9 year old disturbed stands resulted in an approximately 0.05 increase in adult female moose survival. 

```{r, mixed model regression area all lt 9 yo x survival rate, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
data$prop_disturb_all_8_year <- data$prop_cut_8_year_area_ha + data$prop_mpb_all_8_year_area_ha
lme.fit <- lme (af_survival_rate_all ~ prop_disturb_all_8_year, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_disturb_all_8_year, 
                   y = af_survival_rate_all)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_disturb_all_8_year, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 8. Adult Female Moose Survival Rate by Proportion of Area of 
Disturbed Stands Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Disturbed Stands and Cutblocks Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.4, by = 0.05)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

When considering only mortalities from wolves (Fig. 9), the effect of less than 9 year old disturbed stands was not statistically significant (*t-value* = 1.60, *p-value* = 0.147), and each 10% increase in the percent of area of the study area that was less than 9 year old disturbed stands resulted in an approximately 0.04 increase in adult female moose survival.

```{r, mixed model regression area all lt 9 yo x survival rate wolves, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
data <- data %>%
          filter (af_survival_rate_wolf > 0) # remove '0' values
data$prop_disturb_all_8_year <- data$prop_cut_8_year_area_ha + data$prop_mpb_all_8_year_area_ha
lme.fit <- lme (af_survival_rate_wolf ~ prop_disturb_all_8_year, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_disturb_all_8_year, 
                   y = af_survival_rate_wolf)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_disturb_all_8_year, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 9. Adult Female Moose Survival Rate, When Considering Wolf 
Mortalities Only, by Proportion of Area of Disturbed Stands Less Than 9 Years Old in the Study Area MCPs",
        x = "Porportion Disturbed Stands Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate (Wolf Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

When considering only mortalities from hunting (Fig. 10), the effect of less than 9 year old disturbed stands was not statistically significant (*t-value* = 0.62, *p-value* = 0.560), and close to zero. 

```{r, mixed model regression area all lt 9 yo x survival rate hunt, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
data <- data %>%
          filter (af_survival_rate_hunt > 0) # remove '0' values
data$prop_disturb_all_8_year <- data$prop_cut_8_year_area_ha + data$prop_mpb_all_8_year_area_ha
lme.fit <- lme (af_survival_rate_hunt ~ prop_disturb_all_8_year, 
                random = ~ 1 | name_sa, 
                correlation = corAR1 (form = ~1 | name_sa), 
                data = data) 
summary (lme.fit)$tTable
ggplot (data, aes (x = prop_disturb_all_8_year, 
                   y = af_survival_rate_hunt)) +
  geom_point (aes (shape = name_sa)) +
  geom_line (aes (x = prop_disturb_all_8_year, 
                   y = predict (lme.fit, newdata = data, level = 0))) +
  labs (title = "Figure 7. Adult Female Moose Survival Rate, When Considering Hunting 
Mortalities Only, by Proportion of Area of Disturbed Stands Than 9 Years Old 
in the Study Area MCPs",
        x = "Porportion Disturbed Stands Less Than 9 years Old",
        y = "Adult Female Moose Survival Rate (Hunting Mortalities)",
       caption = "Note: Black line shows model fitted relationship.") + 
  scale_shape_discrete (name = "Study Area") +
  scale_x_continuous (breaks = seq (0, 0.2, by = 0.02)) +
  scale_y_continuous (breaks = seq (0.75, 1, by = 0.025)) +
  theme_classic () 

```

## Preliminary Conclusions
The best fit model included the effect of less than 9 year old cutblocks on adult female moose survival, considering all mortality types. However, hunting mortality did not appear to be related to cutblock disturbance. Recent mountain pine beetle disturbance did not appear to effect adult female moose survival.  

The results suggest that recent forest harvest has an overall positive effect on moose survival. At a 'population scale', forest harvest may reduce mortality from wolves and 'other' types, and did not appear to make moose more vulnerable to human hunters. 
