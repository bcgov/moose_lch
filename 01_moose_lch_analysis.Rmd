---
title: "Moose Landcape Change Hypothesis Analysis"
author: "Tyler Muhly"
date: "12/12/2019"
output: html_document:
  keep_md: yes
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (data.table)
library (downloader)
library (dplyr)
library (ggplot2)
library (here)
library (lwgeom)
library (sf)
library (kableExtra)
```

## Introduction
Here I summarize data to explore the moose 'landscape change hypothesis' (LCH). The moose LCH posits that recent moose population declines in parts of central British Columbia (BC) were related to large-scale changes to forest cover (i.e., landscape disturbance), caused by an extensive mountain pine beetle (MBP) infestation and subsequent forest harvest to salvage MPB killed forest stands. As a preliminary test of the LCH, I relate estimates of forest disturbance from MPB and forestry (cutblocks) to estimates of adult female moose survival and cow/calf moose ratios measured in five study areas. 

The LCH predicts a negative correlative relationship between the amount of landscape disturbance and adult female survival or the ratio of calves to cow moose. This relationship is indicative that processes related to landscape disturbance, i.e., reduced amount of security and thermal cover and increased amount of negative interactions with humans (e.g., hunting mortality) due to higher road densities are causing moose population declines. 

## Methods

### Study Areas
The LCH was tested by sampling moose survival rates in the Big Creek, Bonaparte, Entiako, John Prince Research Forest (JPRF) and Prince George South study areas. These five study areas were selected because they had varied levels of MPB and forestry related disturbance. A sample of moose in each study area were captured annually and collared with global positioning system (GPS) telemetry collars. Annual moose study area boundaries were determined by calculating the 100% minimum convex polygon MCP of annual sampled adult female moose GPS locations in each area. Moose locations were collected for four years from 2015 to 2018 (except Entiako, where data was also collected in 2014), and thus study area boundaries were re-calcualted for each of these years.  

### Population Data 
Adult female moose survival rates were estimated from mortality data collected from the sampled animals. Survival was estimated for a biological year, i.e., April to April(?), not a calendar year. Thus, for example, a surival estimate for 2015 was cauclated using mortality data collected from April 2014 to April 2015. In addition, aerial cow/calf composition surveys were completed annually in each study area in ????.

```{r, management unit spatial data, eval = F, echo = F, message = F, warning = F}

# load the mcp's
poly.sa.bc.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2014_15_MCP"), 
                         crs = 3005) # setting these all to the same coordinate system
poly.sa.bc.14.15$year <- 2015 # add year
poly.sa.bc.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2015_16_MCP"), 
                         crs = 3005)
poly.sa.bc.15.16$year <- 2016 # add year
poly.sa.bc.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2016_17_MCP"), 
                         crs = 3005)
poly.sa.bc.16.17$year <- 2017 # add year
poly.sa.bc.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "BigCreek_2017_18_MCP"), 
                         crs = 3005)
poly.sa.bc.17.18$year <- 2018 # add year
poly.sa.jprf.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2014_15_MCP"), 
                         crs = 3005)
poly.sa.jprf.14.15$year <- 2015 
poly.sa.jprf.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2015_16_MCP"), 
                         crs = 3005)
poly.sa.jprf.15.16$year <- 2016 
poly.sa.jprf.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2016_17_MCP"), 
                         crs = 3005)
poly.sa.jprf.16.17$year <- 2017
poly.sa.jprf.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "JPRF_2017_18_MCP"), 
                         crs = 3005)
poly.sa.jprf.17.18$year <- 2018
poly.sa.pgs.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2014_15_MCP"), 
                         crs = 3005)
poly.sa.pgs.14.15$year <- 2015
poly.sa.pgs.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2015_16_MCP"), 
                         crs = 3005)
poly.sa.pgs.15.16$year <- 2016
poly.sa.pgs.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2016_17_MCP"), 
                         crs = 3005)
poly.sa.pgs.16.17$year <- 2017
poly.sa.pgs.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/PGS_JPRF_BigCreek_MCPs.gdb/PGS_JPRF_BigCreek_MCPs.gdb"),
                         layer = "PGS_2017_18_MCP"), 
                         crs = 3005)  
poly.sa.pgs.17.18$year <- 2018
poly.sa.bon.14.15 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon14_15MCP.shp")), 
                         crs = 3005)
poly.sa.bon.14.15$year <- 2015
poly.sa.bon.15.16 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon15_16MCP.shp")), 
                         crs = 3005)
poly.sa.bon.15.16$year <- 2016
poly.sa.bon.16.17 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon16_17MCP.shp")), 
                         crs = 3005)
poly.sa.bon.16.17$year <- 2017
poly.sa.bon.17.18 <- st_transform (st_read (dsn = here ( "./data/mcp/bonaparte/Bon17_18MCP.shp")), 
                         crs = 3005)
poly.sa.bon.17.18$year <- 2018
poly.sa.entiako <- st_transform (st_read (dsn = here ( "./data/mcp/entiako/mmcp100.shp")), 
                         crs = 3005)

# bind them up by area, add area names adn make fields consistent
# Big Creek
poly.sa.bc <- rbind (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
poly.sa.bc$name_sa <- "Big Creek"
poly.sa.bc$area_ha <- poly.sa.bc$area * 0.0001
poly.sa.bc$Shape_Length <- NULL
poly.sa.bc$Shape_Area <- NULL
poly.sa.bc$area <- NULL
poly.sa.bc$id <- 1
names(poly.sa.bc)[names(poly.sa.bc) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.bc) <- "geometry"
rm (poly.sa.bc.14.15, poly.sa.bc.15.16, poly.sa.bc.16.17, poly.sa.bc.17.18)
gc ()

# John Prince Research Forest
poly.sa.jprf <- rbind (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
names(poly.sa.jprf)[names(poly.sa.jprf) == "Id"] = "id" # rename the Id column
poly.sa.jprf$id <- 2
poly.sa.jprf$area_ha <- (st_area (poly.sa.jprf$Shape) * 0.0001) # area needs to be calc'd
poly.sa.jprf$name_sa <- "John Prince Research Forest"
poly.sa.jprf$Shape_Length <- NULL
poly.sa.jprf$Shape_Area <- NULL
names(poly.sa.jprf)[names(poly.sa.jprf) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.jprf) <- "geometry"
rm (poly.sa.jprf.14.15, poly.sa.jprf.15.16, poly.sa.jprf.16.17, poly.sa.jprf.17.18)
gc ()

# Prince George South
poly.sa.pgs <- rbind (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
names(poly.sa.pgs)[names(poly.sa.pgs) == "Id"] = "id" 
poly.sa.pgs$id <- 3
poly.sa.pgs$area_ha <- (st_area (poly.sa.pgs$Shape) * 0.0001)
poly.sa.pgs$name_sa <- "Prince George South"
poly.sa.pgs$Shape_Length <- NULL
poly.sa.pgs$Shape_Area <- NULL
names(poly.sa.pgs)[names(poly.sa.pgs) == "Shape"] = "geometry" # rename the geometry column
st_geometry (poly.sa.pgs) <- "geometry"
rm (poly.sa.pgs.14.15, poly.sa.pgs.15.16, poly.sa.pgs.16.17, poly.sa.pgs.17.18)
gc ()

# Bonaparte
poly.sa.bon <- rbind (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
names(poly.sa.bon)[names(poly.sa.bon) == "Id"] = "id" 
poly.sa.bon$id <- 4
poly.sa.bon$area_ha <- (st_area (poly.sa.bon$geometry) * 0.0001)
poly.sa.bon$name_sa <- "Bonaparte"
rm (poly.sa.bon.14.15, poly.sa.bon.15.16, poly.sa.bon.16.17, poly.sa.bon.17.18)
gc ()

# Entiako
poly.sa.entiako$year <- 2014
poly.sa.entiako [2, 4] <- 2015 # making year consitent with other data
poly.sa.entiako [3, 4] <- 2016
poly.sa.entiako [4, 4] <- 2017
poly.sa.entiako [5, 4] <- 2018
poly.sa.entiako$name_sa <- "Entiako"
poly.sa.entiako$id <- 5
poly.sa.entiako$area_ha <- poly.sa.entiako$area
poly.sa.entiako$area <- NULL

# all together now...
poly.sa <- rbind (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
rm (poly.sa.bc, poly.sa.jprf, poly.sa.pgs, poly.sa.bon, poly.sa.entiako)
gc ()

# unique identifier for each
poly.sa$unique_id <- with (poly.sa, paste0 (as.character (name_sa), as.character (year)))

# save it 
st_write (poly.sa, 
          dsn = here ("./data/mcp/"), 
          layer = "study_area_mcp_moose", 
          driver = "ESRI Shapefile")
```

### Measuring Area of Cutblocks in Study Areas
I estimated the area of less than 8 and 15 year old forestry cutblocks and MPB disturbed stands in each study area. I estimated the area of cutblocks using the [consolidated cutblocks](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-) dataset for BC. I intersected this data with the study area boundaries and then summarized the area cut by year from 1970 to 2018. I then calculated the area of cutblocks less than 8 and 15 years old for each study area year to align with adult female moose survival estimates for that year. For example, for survival estimates calculated for year 2015, I calcualted the area cut form 2008 to 2015 as an estimaet dof area cut less than 8 years old. Thus, the assumption was the majpority of area was cut in early in the calendar year, during the period which survival estimates were calculated. 

```{r, cutblock data download and attribute to study areas, eveal = F, echo = T, message = F, warning = F}

# library (bcdata) # use this to conenct to bcgw via R
# cutblocks <- bcdc_get_data ('b1b647a6-f271-42e0-9cd0-89ec24bce9f7', resource = '66656966-8af6-4e32-8de1-b79c63cae40f') # name of the data in BCGW; I noticed there are 413451 rows form here, whereas 446,987 in the BCGW; not sure why they are different, but this version likely underestimates the area of cutblocks; so I used the BCGW data and imported it here...
cutblocks <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\moose_lch.gdb",
                          layer = "cutblocks_20191217")
cutblocks <- lwgeom::st_make_valid (cutblocks) # fix any geometry errors

# intersect cutblocks with study area values
sa.cutblocks <- sf::st_intersection (cutblocks, poly.sa ["unique_id"]) # intersect the study area ID
table.sa.cutblocks <- as.data.table (sa.cutblocks)

# summarize cut by study area
table.sa.cutblocks.mum <- table.sa.cutblocks %>% 
                             group_by (unique_id, HARVEST_YEAR) %>%
                             summarise (area_ha = sum (AREA_HA)) # calculate area of cut by year

# get study area id
poly.sa.habitat <- as.data.table (poly.sa)
poly.sa.habitat$geometry <- NULL

## these next steps left-join the cutblock data to wmu data ##
### Subset the harvest years ###
#### 1980 to 2018 ####
fxn.cut.year <- function (year, table.sa.cutblocks.mum, poly.sa.habitat) {
  table <- as.data.table (table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR == year, ])
  table [, paste0 ("cut_", year, "_area_ha") := area_ha] 
  table$area_ha <- NULL
  table$HARVEST_YEAR <- NULL
  setkey (table, unique_id)
  setkey (poly.sa.habitat, unique_id)
  poly.sa.habitat <- merge (poly.sa.habitat, table, all.x = TRUE)
  poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
  poly.sa.habitat <<- poly.sa.habitat
}

year <- 2018
fxn.cut.year (year, table.sa.cutblocks.mum, poly.sa.habitat)
  
#### 1970 to 1979 ####
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.mum [table.sa.cutblocks.mum$HARVEST_YEAR > 1969 & table.sa.cutblocks.mum$HARVEST_YEAR < 1980, ]
table.sa.cutblocks.1970to1979.mum <- table.sa.cutblocks.1970to1979.mum %>% 
                                          group_by (unique_id) %>%
                                          summarise (area_ha = sum (area_ha))
table.sa.cutblocks.1970to1979.mum$cut_1970to1979_area_ha <- table.sa.cutblocks.1970to1979.mum$area_ha
table.sa.cutblocks.1970to1979.mum$area_ha <- NULL
table.sa.cutblocks.1970to1979.mum <- as.data.table(table.sa.cutblocks.1970to1979.mum)
setkey (table.sa.cutblocks.1970to1979.mum, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.sa.cutblocks.1970to1979.mum, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0 # if NA values
rm (table.sa.cutblocks.1970to1979.mum)
gc ()

# 8 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_8_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha]
poly.sa.habitat [year == 2015, cut_8_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha] #where year = 2015
poly.sa.habitat [year == 2016, cut_8_year_area_ha := cut_2016_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha] #where year = 2016
poly.sa.habitat [year == 2017, cut_8_year_area_ha := cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha] 
poly.sa.habitat [year == 2018, cut_8_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha] 

# 15 year cumulative cut disturbance 
poly.sa.habitat [year == 2014, cut_25_year_area_ha := cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha + cut_1990_area_ha]
poly.sa.habitat [year == 2015, cut_25_year_area_ha := cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha + cut_1991_area_ha] 
poly.sa.habitat [year == 2017, cut_25_year_area_ha := cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha + cut_1992_area_ha] 
poly.sa.habitat [year == 2017, cut_25_year_area_ha := cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha + cut_1993_area_ha] 
poly.sa.habitat [year == 2018, cut_25_year_area_ha := cut_2018_area_ha + cut_2017_area_ha + cut_2017_area_ha + cut_2015_area_ha + cut_2014_area_ha + cut_2013_area_ha + cut_2012_area_ha + cut_2011_area_ha + cut_2010_area_ha + cut_2009_area_ha + cut_2008_area_ha + cut_2007_area_ha + cut_2006_area_ha + cut_2005_area_ha + cut_2004_area_ha + cut_2003_area_ha + cut_2002_area_ha + cut_2001_area_ha + cut_2000_area_ha + cut_1999_area_ha + cut_1998_area_ha + cut_1997_area_ha + cut_1996_area_ha + cut_1995_area_ha + cut_1994_area_ha] 

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))

rm (cutblocks, table.sa.cutblocks, table.sa.cutblocks.mum, sa.cutblocks)
gc ()
```

### Measuring Area of Mountain Pine Beetle Disturbed Stands in Study Areas
I estimated the area of forest stands disturbed by mountain pine beetle in each study area using data collected from [annual aerial surveys](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/forest-health/aerial-overview-surveys/methods) by the government of BC. These data were accessible through an [FTP site](https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/), and I downloaded annual datsets from 1999 to 2018.  I summarized the area of moderately (11 to 29%), severely (30 to 49%) and very severely (>50%) disturbed forest stands for each year. I then calculated the area of MPB disturbed stands less than 8 and 15 years old for each study area year to align with adult female moose survival estimates for that year. MPB surveys are completed in July-August, thus, for example, for survival estimates calculated for year 2015, I calcualted the area of MPB disturbed stands from 2008 to 2015 as an estimate of area of MPB stands less than 8 years old. 

```{r, forest health data download and attribute beetle disturbance to study areas, echo = T, message = F, warning = F, eval = F}

# Download data; this is an example; do these for each year and save it locally
download ("https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/1999/shape/Prov_Shape.zip", 
            dest = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
            mode = "wb")
unzip ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
       exdir = "C:\\Work\\caribou\\clus_data\\forest_health\\1999")
file.remove ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip")

#########################################################
# Determine MPB affected stands by year - 1998 to 2008 #
#######################################################
#------------------------------------------------------
# I found that MPB data wasn't updated annualy, e.g., a surveyed stand in 1998 
# may not necessarily be re-surveyd in 1999. So, I had to 'erase' current years data from previous years data (cumulative), and then merge that with the cumulative mpb disturbance to date
### in R, but it TOOK AWHILE, SO I DID THE GIS PROCESSING IN ARCGIS ###

# do the analysis using the data processed in ArcGIS
  # clipped to study area
  # unioned with study area
  # area in ha calc (POLY_AREA)
  # erase new data from previous data
  # merge new data to cumulative data

# function to load and overlay mpb data by year and study area 

fxn.mpb.summary <- function (dsn, survey.year, poly.sa.habitat) {
fh <- sf::st_read (dsn = paste0 (dsn))
mpb <- fh %>%
        filter(FHF == "IBM") %>%
        filter (SEVERITY == "M" | SEVERITY == "S" | SEVERITY == "V")
table <- as.data.table (mpb)  
table$survey.year <- paste0 (survey.year)
table.cast <- as.data.table (dcast (table, 
                                    unique_id ~ YEAR_1 + SEVERITY + survey.year, 
                                    value.var = "POLY_AREA",  
                                    fun = sum))
setkey (table.cast, unique_id)
setkey (poly.sa.habitat, unique_id)
poly.sa.habitat <- merge (poly.sa.habitat, table.cast, all.x = TRUE)
poly.sa.habitat [is.na (poly.sa.habitat)] <- 0
poly.sa.habitat <<- poly.sa.habitat
}

fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_1999_sa_union.shp", 
 "survey1999", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2000_cumul.shp", 
  "survey2000", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2001_cumul.shp", 
  "survey2001", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2002_cumul.shp", 
 "survey2002", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2003_cumul.shp", 
 "survey2003", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2004_cumul.shp", 
  "survey2004", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2005_cumul.shp", 
  "survey2005", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2006_cumul.shp", 
  "survey2006", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2007_cumul.shp", 
  "survey2007", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2008_cumul.shp", 
  "survey2008", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2009_cumul.shp", 
  "survey2009", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2010_cumul.shp", 
  "survey2010", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2011_cumul.shp", 
  "survey2011", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2012_cumul.shp", 
  "survey2012", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2013_cumul.shp", 
  "survey2013", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2014_cumul.shp", 
 "survey2014", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2015_cumul.shp", 
  "survey2015", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2016_cumul.shp", 
  "survey2016", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2017_cumul.shp", 
  "survey2017", 
   poly.sa.habitat)
fxn.mpb.summary (
  "C:\\Work\\caribou\\clus_data\\forest_health\\mpb_sa\\fh_2018_cumul.shp", 
  "survey2018", 
   poly.sa.habitat)

# severity types: very severe (>50% of Trees in Polygon Recently Killed), severe (30% to 49%), moderate (11% to 29%)

# Cumulative mpb  
### NOTE: for MPB, each year survey is cumulative, impact of previous years are included in last year, so use last survey year 
poly.sa.habitat [year == 2014, mpb_m_8_year_area_ha_2014 := `X2014_M_survey2014` + `X2013_M_survey2014` + `X2012_M_survey2014` + `X2011_M_survey2014` + `X2010_M_survey2014` + `X2009_M_survey2014` + `X2008_M_survey2014` + `X2007_M_survey2014`]
poly.sa.habitat [year == 2014, mpb_s_8_year_area_ha_2014 :=    `X2012_S_survey2014` + `X2010_S_survey2014` + `X2009_S_survey2014` + `X2008_S_survey2014` + `X2007_S_survey2014` ] # no data   `X2014_S_survey2014` +  `X2013_S_survey2014` + `X2011_S_survey2014`  + 
poly.sa.habitat [year == 2014, mpb_vs_8_year_area_ha_2014 :=    `X2011_V_survey2014` +   `X2009_V_survey2014` + `X2008_V_survey2014` + `X2007_V_survey2014`] # no data   `X2014_V_survey2014` + `X2013_V_survey2014` + `X2012_V_survey2014` + `X2010_V_survey2014` +

poly.sa.habitat [year == 2015, mpb_m_8_year_area_ha_2015 := `X2015_M_survey2015` + `X2014_M_survey2015` + `X2013_M_survey2015` + `X2012_M_survey2015` + `X2011_M_survey2015` + `X2010_M_survey2015` + `X2009_M_survey2015` + `X2008_M_survey2015`]
poly.sa.habitat [year == 2015, mpb_s_8_year_area_ha_2015 :=  `X2012_S_survey2015` + `X2010_S_survey2015` + `X2009_S_survey2015` + `X2008_S_survey2015`] # no data `X2015_S_survey2015` +  `X2014_S_survey2015` + `X2013_S_survey2015` + `X2011_S_survey2015` + 
poly.sa.habitat [year == 2015, mpb_vs_8_year_area_ha_2015 :=    `X2011_V_survey2015` +  `X2009_V_survey2015` + `X2008_V_survey2015`] # no data `X2015_V_survey2015` +  `X2014_V_survey2015` +  `X2013_V_survey2015` + `X2012_V_survey2015` + `X2010_V_survey2015` + 

poly.sa.habitat [year == 2016, mpb_m_8_year_area_ha_2016 := `X2016_M_survey2016` + `X2015_M_survey2016` + `X2014_M_survey2016` + `X2013_M_survey2016` + `X2012_M_survey2016` + `X2011_M_survey2016` + `X2010_M_survey2016` + `X2009_M_survey2016`]
poly.sa.habitat [year == 2016, mpb_s_8_year_area_ha_2016 :=  `X2016_S_survey2016` +   `X2012_S_survey2016` +  `X2010_S_survey2016` + `X2009_S_survey2016`] # no data  `X2015_S_survey2016` + `X2014_S_survey2016` + `X2013_S_survey2016` +  `X2011_S_survey2016` +
poly.sa.habitat [year == 2016, mpb_vs_8_year_area_ha_2016 := `X2011_V_survey2016` +  `X2009_V_survey2016`] # no data  `X2016_V_survey2016` + `X2015_V_survey2016` + `X2014_V_survey2016` + `X2013_V_survey2016` +  `X2012_V_survey2016` + `X2010_V_survey2016` + 

poly.sa.habitat [year == 2017, mpb_m_8_year_area_ha_2017 := `X2017_M_survey2017` + `X2016_M_survey2017` + `X2015_M_survey2017` + `X2014_M_survey2017` + `X2013_M_survey2017` + `X2012_M_survey2017` + `X2011_M_survey2017` + `X2010_M_survey2017`]
poly.sa.habitat [year == 2017, mpb_s_8_year_area_ha_2017 :=  `X2017_S_survey2017` +  `X2016_S_survey2017` +   `X2012_S_survey2017` +   `X2010_S_survey2017`] # no data  `X2015_S_survey2017` + `X2014_S_survey2017` + `X2013_S_survey2017` + `X2011_S_survey2017` +
poly.sa.habitat [year == 2017, mpb_vs_8_year_area_ha_2017 :=  `X2011_V_survey2017` ] # no data  `X2017_V_survey2017` + `X2016_V_survey2017` + `X2015_V_survey2017` +  `X2014_V_survey2017` + `X2013_V_survey2017` + `X2012_V_survey2017`+ `X2010_V_survey2017`

poly.sa.habitat [year == 2018, mpb_m_8_year_area_ha_2018 := `X2018_M_survey2018` + `X2017_M_survey2018` + `X2016_M_survey2018` + `X2015_M_survey2018` + `X2014_M_survey2018` + `X2013_M_survey2018` + `X2012_M_survey2018` + `X2011_M_survey2018`]
poly.sa.habitat [year == 2018, mpb_s_8_year_area_ha_2018 :=  `X2018_S_survey2018` + `X2017_S_survey2018` + `X2016_S_survey2018` + `X2012_S_survey2018`] # no data  `X2015_S_survey2018` + `X2014_S_survey2018` + `X2013_S_survey2018` + `X2011_S_survey2018` +  
poly.sa.habitat [year == 2018, mpb_vs_8_year_area_ha_2018 :=   `X2011_V_survey2018` ] # no data  `X2018_V_survey2018` + `X2017_V_survey2018` + `X2016_V_survey2018` + `X2015_V_survey2018` + `X2014_V_survey2018` +  `X2013_V_survey2018` + `X2012_V_survey2018`+


poly.sa.habitat [year == 2014, mpb_m_15_year_area_ha_2014 := `X2014_M_survey2014` + `X2013_M_survey2014` + `X2012_M_survey2014` + `X2011_M_survey2014` + `X2010_M_survey2014` + `X2009_M_survey2014` + `X2008_M_survey2014` + `X2007_M_survey2014` + `X2006_M_survey2014` + `X2005_M_survey2014` + `X2004_M_survey2014` + `X2003_M_survey2014` + `X2002_M_survey2014` + `X2001_M_survey2014` + `X2000_M_survey2014`]
poly.sa.habitat [year == 2014, mpb_s_15_year_area_ha_2014 :=   `X2012_S_survey2014` + `X2010_S_survey2014` + `X2009_S_survey2014` + `X2008_S_survey2014` + `X2007_S_survey2014` + `X2006_S_survey2014` + `X2005_S_survey2014` + `X2004_S_survey2014` + `X2003_S_survey2014` + `X2002_S_survey2014` + `X2001_S_survey2014` + `X2000_S_survey2014`] # no data `X2014_S_survey2014` + `X2013_S_survey2014` + `X2011_S_survey2014` + 
poly.sa.habitat [year == 2014, mpb_vs_15_year_area_ha_2014 :=   `X2011_V_survey2014` +  `X2009_V_survey2014` + `X2008_V_survey2014` + `X2007_V_survey2014` + `X2006_V_survey2014` + `X2005_V_survey2014` + `X2004_V_survey2014` + `X2003_V_survey2014` ]  # no data `X2014_V_survey2014` +  `X2013_V_survey2014` + `X2012_V_survey2014` + `X2010_V_survey2014` + `X2002_V_survey2014` + `X2001_V_survey2014` +   `X2000_V_survey2014`

poly.sa.habitat [year == 2015, mpb_m_15_year_area_ha_2015 := `X2015_M_survey2015` + `X2014_M_survey2015` + `X2013_M_survey2015` + `X2012_M_survey2015` + `X2011_M_survey2015` + `X2010_M_survey2015` + `X2009_M_survey2015` + `X2008_M_survey2015` + `X2007_M_survey2015` + `X2006_M_survey2015` + `X2005_M_survey2015` + `X2004_M_survey2015` + `X2003_M_survey2015` + `X2002_M_survey2015` + `X2001_M_survey2015`]
poly.sa.habitat [year == 2015, mpb_s_15_year_area_ha_2015 :=   `X2012_S_survey2015` + `X2010_S_survey2015` + `X2009_S_survey2015` + `X2008_S_survey2015` + `X2007_S_survey2015` + `X2006_S_survey2015` + `X2005_S_survey2015` + `X2004_S_survey2015` + `X2003_S_survey2015` + `X2002_S_survey2015` + `X2001_S_survey2015`]  # no data `X2015_S_survey2015` + `X2014_S_survey2015` +  `X2013_S_survey2015` + `X2011_S_survey2015` + 
poly.sa.habitat [year == 2015, mpb_vs_15_year_area_ha_2015 :=   `X2011_V_survey2015` + `X2009_V_survey2015` + `X2008_V_survey2015` + `X2007_V_survey2015` + `X2006_V_survey2015` + `X2005_V_survey2015` + `X2004_V_survey2015` + `X2003_V_survey2015` ] # no data `X2015_V_survey2015` + `X2014_V_survey2015` + `X2013_V_survey2015` +   `X2012_V_survey2015` + `X2010_V_survey2015` + `X2002_V_survey2015` +  `X2001_V_survey2015`

poly.sa.habitat [year == 2016, mpb_m_15_year_area_ha_2016 := `X2016_M_survey2016` + `X2015_M_survey2016` + `X2014_M_survey2016` + `X2013_M_survey2016` + `X2012_M_survey2016` + `X2011_M_survey2016` + `X2010_M_survey2016` + `X2009_M_survey2016` + `X2008_M_survey2016` + `X2007_M_survey2016` + `X2006_M_survey2016` + `X2005_M_survey2016` + `X2004_M_survey2016` + `X2003_M_survey2016` + `X2002_M_survey2016`]
poly.sa.habitat [year == 2016, mpb_s_15_year_area_ha_2016 := `X2016_S_survey2016` + `X2012_S_survey2016` + `X2010_S_survey2016` + `X2009_S_survey2016` + `X2008_S_survey2016` + `X2007_S_survey2016` + `X2006_S_survey2016` + `X2005_S_survey2016` + `X2004_S_survey2016` + `X2003_S_survey2016` + `X2002_S_survey2016`] # no data `X2015_S_survey2016` + `X2014_S_survey2016` + `X2013_S_survey2016` + `X2011_S_survey2016` + 
poly.sa.habitat [year == 2016, mpb_vs_15_year_area_ha_2016 :=   `X2011_V_survey2016` +  `X2009_V_survey2016` + `X2008_V_survey2016` + `X2007_V_survey2016` + `X2006_V_survey2016` + `X2005_V_survey2016` + `X2004_V_survey2016` + `X2003_V_survey2016`] # no data `X2016_V_survey2016` +  `X2015_V_survey2016` +  `X2014_V_survey2016` + `X2013_V_survey2016` + `X2012_V_survey2016` + `X2010_V_survey2016`  + `X2002_V_survey2016`

poly.sa.habitat [year == 2017, mpb_m_15_year_area_ha_2017 := `X2017_M_survey2017` + `X2016_M_survey2017` + `X2015_M_survey2017` + `X2014_M_survey2017` + `X2013_M_survey2017` + `X2012_M_survey2017` + `X2011_M_survey2017` + `X2010_M_survey2017` + `X2009_M_survey2017` + `X2008_M_survey2017` + `X2007_M_survey2017` + `X2006_M_survey2017` + `X2005_M_survey2017` + `X2004_M_survey2017` + `X2003_M_survey2017`]
poly.sa.habitat [year == 2017, mpb_s_15_year_area_ha_2017 := `X2017_S_survey2017` + `X2016_S_survey2017` +  `X2012_S_survey2017` +  `X2010_S_survey2017` + `X2009_S_survey2017` + `X2008_S_survey2017` + `X2007_S_survey2017` + `X2006_S_survey2017` + `X2005_S_survey2017` + `X2004_S_survey2017` + `X2003_S_survey2017`] # no data `X2015_S_survey2017` + `X2014_S_survey2017` + `X2013_S_survey2017` + `X2011_S_survey2017` +
poly.sa.habitat [year == 2017, mpb_vs_15_year_area_ha_2017 :=   `X2011_V_survey2017` + `X2009_V_survey2017` + `X2008_V_survey2017` + `X2007_V_survey2017` + `X2006_V_survey2017` + `X2005_V_survey2017` + `X2004_V_survey2017` + `X2003_V_survey2017`] # no data: `X2017_V_survey2017` + `X2016_V_survey2017` +  `X2015_V_survey2017` +  `X2014_V_survey2017` + `X2013_V_survey2017` +   `X2012_V_survey2017` + `X2010_V_survey2017` + 

poly.sa.habitat [year == 2018, mpb_m_15_year_area_ha_2018 := `X2018_M_survey2018` +  `X2017_M_survey2018` + `X2016_M_survey2018` + `X2015_M_survey2018` + `X2014_M_survey2018` + `X2013_M_survey2018` + `X2012_M_survey2018` + `X2011_M_survey2018` + `X2010_M_survey2018` + `X2009_M_survey2018` + `X2008_M_survey2018` + `X2007_M_survey2018` + `X2006_M_survey2018` + `X2005_M_survey2018` + `X2004_M_survey2018`]
poly.sa.habitat [year == 2018, mpb_s_15_year_area_ha_2018 := `X2018_S_survey2018` + `X2017_S_survey2018` + `X2016_S_survey2018` +  `X2012_S_survey2018` + `X2010_S_survey2018` + `X2009_S_survey2018` + `X2008_S_survey2018` + `X2007_S_survey2018` + `X2006_S_survey2018` + `X2005_S_survey2018` + `X2004_S_survey2018`] # no data: `X2015_S_survey2018` + `X2014_S_survey2018` +  `X2013_S_survey2018` + `X2011_S_survey2018` +
poly.sa.habitat [year == 2018, mpb_vs_15_year_area_ha_2018 := `X2011_V_survey2018` +  `X2009_V_survey2018` + `X2008_V_survey2018` + `X2007_V_survey2018` + `X2006_V_survey2018` + `X2005_V_survey2018` + `X2004_V_survey2018`] # no data: `X2018_V_survey2018` +  `X2017_V_survey2018` + `X2016_V_survey2018` + `X2015_V_survey2018` +  `X2014_V_survey2018` + `X2013_V_survey2018` +  `X2012_V_survey2018` + `X2010_V_survey2018` +

poly.sa.habitat[is.na(poly.sa.habitat)] <- 0

poly.sa.habitat [, mpb_m_8_year_area_ha :=   `mpb_m_8_year_area_ha_2014` + `mpb_m_8_year_area_ha_2015` + `mpb_m_8_year_area_ha_2016` +  `mpb_m_8_year_area_ha_2017` + `mpb_m_8_year_area_ha_2018`]
poly.sa.habitat [, mpb_s_8_year_area_ha :=   `mpb_s_8_year_area_ha_2014` + `mpb_s_8_year_area_ha_2015` + `mpb_s_8_year_area_ha_2016` +  `mpb_s_8_year_area_ha_2017` + `mpb_s_8_year_area_ha_2018`]
poly.sa.habitat [, mpb_vs_8_year_area_ha :=   `mpb_vs_8_year_area_ha_2014` + `mpb_vs_8_year_area_ha_2015` + `mpb_vs_8_year_area_ha_2016` +  `mpb_vs_8_year_area_ha_2017` + `mpb_vs_8_year_area_ha_2018`]

poly.sa.habitat [, mpb_all_8_year_area_ha :=   `mpb_m_8_year_area_ha` + `mpb_s_8_year_area_ha` + `mpb_vs_8_year_area_ha`]

poly.sa.habitat [, mpb_m_15_year_area_ha :=   `mpb_m_15_year_area_ha_2014` + `mpb_m_15_year_area_ha_2015` + `mpb_m_15_year_area_ha_2016` +  `mpb_m_15_year_area_ha_2017` + `mpb_m_15_year_area_ha_2018`]
poly.sa.habitat [, mpb_s_15_year_area_ha :=   `mpb_s_15_year_area_ha_2014` + `mpb_s_15_year_area_ha_2015` + `mpb_s_15_year_area_ha_2016` +  `mpb_s_15_year_area_ha_2017` + `mpb_s_15_year_area_ha_2018`]
poly.sa.habitat [, mpb_vs_15_year_area_ha :=   `mpb_vs_15_year_area_ha_2014` + `mpb_vs_15_year_area_ha_2015` + `mpb_vs_15_year_area_ha_2016` +  `mpb_vs_15_year_area_ha_2017` + `mpb_vs_15_year_area_ha_2018`]

poly.sa.habitat [, mpb_all_15_year_area_ha :=   `mpb_m_15_year_area_ha` + `mpb_s_15_year_area_ha` + `mpb_vs_15_year_area_ha`]


poly.sa.habitat.sum <- poly.sa.habitat %>%
                        select (unique_id,	id,	year,	name_sa,	area_ha,	cut_8_year_area_ha,	cut_15_year_area_ha,	cut_25_year_area_ha,	mpb_all_8_year_area_ha,	mpb_all_15_year_area_ha,	mpb_m_8_year_area_ha,	mpb_s_8_year_area_ha,	mpb_vs_8_year_area_ha,	mpb_m_15_year_area_ha,	mpb_s_15_year_area_ha,	mpb_vs_15_year_area_ha)

# save the data
write.csv (poly.sa.habitat, here ("./data/study_area_habitat.csv"))
write.csv (poly.sa.habitat.sum, here ("./data/study_area_habitat_sum.csv"))

```

### Estimating Population Parameters

- estimated survival from mortality data... just using data provided in report so far; not divided into type (human, etc.)
- dependent variables are:
    - annual female survival rate; human and all mortality types
    - change in annual survival rate; human and all mortality types?
    - calves/100 cows and chaneg in calves/100 cows 

```{r population params table, echo = F, message = F, warning = F, eval = T}
table.pop.data = data.table(
  unique_id = c ("Big Creek2015", "Big Creek2016", "Big Creek2017", "Big Creek2018", "Bonaparte2015",
                 "Bonaparte2016", "Bonaparte2017", "Bonaparte2018", "Entiako2014", "Entiako2015", 
                 "Entiako2016", "Entiako2017", "Entiako2018", "John Prince Research Forest2015",
                 "John Prince Research Forest2016", "John Prince Research Forest2017",
                 "John Prince Research Forest2018", "Prince George South2015", 
                 "Prince George South2016", "Prince George South2017", "Prince George South2018"),
  af_survival_rate_all = c (0.923, 0.862, 0.897, 0.901, 0.912, 0.871, 0.906, 0.977, 0.970, 0.913,
                            0.799, 0.775, 0.817, 1, 0.923, 0.949, 0.951, 0.875, 0.842, 0.946, 0.794),
  af_survival_rate_all_95CI = c (0.085, 0.103, 0.143, 0.092, 0.130, 0.092, 0.124, 0.045, NA, 0.081, 
                                 0.111, 0.168, 0.133, 0, 0.084, 0.110, 0.066, 0.162, 0.118, 0.151, 
                                 0.122),
  calves_100cows = c(37, 33, 27, 32, 25, 26, 16, 38, NA, NA, 14, 9, 15, 8, 17, 40, 37, 39, 27, 40,
                     26),
  density = c(170, NA, NA, 220, 296, NA, NA, 254, NA, 267, NA, NA, 217, 770, NA, NA, 490, 630, NA, 
              NA, 400),
  density_95CI = c(39, NA, NA, 38, 18, NA, NA, 41, NA, 45, NA, NA, 46, 93, NA, NA, 84, 102, NA, NA, 
                   78)
)

kable (table.pop.data,
       caption = "<b>Table 1. Moose Population Parameter Estimates.<b>",
       col.names = c("Study Area",
                     "Adult Female Survival Rate",
                      "Adult Female Survival Rate 95%CI",
                      "Calves/100 Cows",
                     "Density",
                     "Density 95%CI")) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

```{r, link pop params to habitat covariates, echo = F, message = F, warning = F, eval = F}

# link pop table to habitat table
setkey (table.pop.data, unique_id)
setkey (poly.sa.habitat.sum, unique_id)
data <- merge (table.pop.data, poly.sa.habitat.sum, all.x = TRUE)

# convert areas to proportion of study area
data [, prop_cut_8_year_area_ha := cut_8_year_area_ha / area_ha]
data [, prop_cut_15_year_area_ha := cut_15_year_area_ha / area_ha]
data [, prop_cut_25_year_area_ha := cut_25_year_area_ha / area_ha]
data [, prop_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha / area_ha]
data [, prop_mpb_m_15_year_area_ha := mpb_m_15_year_area_ha / area_ha]
data [, prop_mpb_s_8_year_area_ha := mpb_s_8_year_area_ha / area_ha]
data [, prop_mpb_s_15_year_area_ha := mpb_s_15_year_area_ha / area_ha]
data [, prop_mpb_vs_8_year_area_ha := mpb_vs_8_year_area_ha / area_ha]
data [, prop_mpb_vs_15_year_area_ha := mpb_vs_15_year_area_ha / area_ha]
data [, prop_mpb_all_8_year_area_ha := mpb_all_8_year_area_ha / area_ha]
data [, prop_mpb_all_15_year_area_ha := mpb_all_15_year_area_ha / area_ha]

# get change in values for comapring rates of change
data [, delta_af_survival_rate_all := af_survival_rate_all - shift (af_survival_rate_all, n = 1, type = "lag"), by = name_sa]
data [, delta_calves_100cows := calves_100cows - shift (calves_100cows, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_8_year_area_ha := cut_8_year_area_ha - shift (cut_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_15_year_area_ha := cut_15_year_area_ha - shift (cut_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_cut_25_year_area_ha := cut_25_year_area_ha - shift (cut_25_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_m_8_year_area_ha := mpb_m_8_year_area_ha - shift (mpb_m_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_s_8_year_area_ha := mpb_s_8_year_area_ha - shift (mpb_s_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_vs_8_year_area_ha := mpb_vs_8_year_area_ha - shift (mpb_vs_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_all_8_year_area_ha := mpb_all_8_year_area_ha - shift (mpb_all_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_m_15_year_area_ha := mpb_m_15_year_area_ha - shift (mpb_m_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_s_15_year_area_ha := mpb_s_15_year_area_ha - shift (mpb_s_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_vs_15_year_area_ha := mpb_vs_15_year_area_ha - shift (mpb_vs_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_mpb_all_15_year_area_ha := mpb_all_15_year_area_ha - shift (mpb_all_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_8_year_area_ha := prop_cut_8_year_area_ha - shift (prop_cut_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_15_year_area_ha := prop_cut_15_year_area_ha - shift (prop_cut_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_cut_25_year_area_ha := prop_cut_25_year_area_ha - shift (prop_cut_25_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_m_8_year_area_ha := prop_mpb_m_8_year_area_ha - shift (prop_mpb_m_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_m_15_year_area_ha := prop_mpb_m_15_year_area_ha - shift (prop_mpb_m_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_s_8_year_area_ha := prop_mpb_s_8_year_area_ha - shift (prop_mpb_s_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_s_15_year_area_ha := prop_mpb_s_15_year_area_ha - shift (prop_mpb_s_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_vs_8_year_area_ha := prop_mpb_vs_8_year_area_ha - shift (prop_mpb_vs_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_vs_15_year_area_ha := prop_mpb_vs_15_year_area_ha - shift (prop_mpb_vs_15_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_all_8_year_area_ha := prop_mpb_all_8_year_area_ha - shift (prop_mpb_all_8_year_area_ha, n = 1, type = "lag"), by = name_sa]
data [, delta_prop_mpb_all_15_year_area_ha := prop_mpb_all_15_year_area_ha - shift (prop_mpb_all_15_year_area_ha, n = 1, type = "lag"), by = name_sa]

data [is.na (data)] <- 0

write.csv (data, here ("./data/data.csv"))
```

## Results
Here I provide a preliminary description of the relationship between landscape disturbance and estimates of moose adult female survival or calves/100 cows. Entiako was typically the largest study area, at approximately 1,000,000 ha, and Bonaparte was typically the smallest study area, at approximately 300,000 ha (Table 2). The JPRF study area had the highest amount of less than 8 year old cutblocks, and Prince George South had the highest amount of less than 15 year old cutblocks. The Big Creek study area typically had the most less than 8 year old MPB disturbed forest stands and ince George South had the highest amount of less than 15 year MPB disturbed forest stands.

```{r, table of disturbance by study area, eval = T, echo = F, message = F, warning = F}
data <- read.csv (here ("./data/data.csv"))
data.disturb.summary <- data %>%
                          select (name_sa, year, area_ha, cut_8_year_area_ha, cut_15_year_area_ha, 
                                  mpb_all_8_year_area_ha, mpb_all_15_year_area_ha)
data.disturb.summary <- data.disturb.summary [order (data.disturb.summary$name_sa, data.disturb.summary$year), ]

data.disturb.summary$cut_8_year_area_ha <- round (data.disturb.summary$cut_8_year_area_ha, digits = 0)
data.disturb.summary$cut_15_year_area_ha <- round (data.disturb.summary$cut_15_year_area_ha, digits = 0)
data.disturb.summary$mpb_all_8_year_area_ha <- round (data.disturb.summary$mpb_all_8_year_area_ha, digits = 0)
data.disturb.summary$mpb_all_15_year_area_ha <- round (data.disturb.summary$mpb_all_15_year_area_ha, digits = 0)
data.disturb.summary$area_ha <- round (data.disturb.summary$area_ha, digits = 0)
data.disturb.summary$year <- as.character(data.disturb.summary$year)
  
kable (data.disturb.summary,
       caption = "<b>Table 2. Summary of Cutblock and Mountain Pine Beetle Disturbance Area by Study Area and Year.<b>",
       col.names = c("Study Area",
                     "Year",
                     "Area (ha)",
                      "Area of Cutblocks Less Than 8 y.o. (ha)",
                      "Area of Cutblocks Less Than 15 y.o. (ha)",
                     "Area of MPB Disturbed Stands Less Than 8 y.o. (ha)",
                     "Area of MPB Disturbed Stands Less Than 15 y.o. (ha)"),
       format.args = list (big.mark = ",")
       ) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

### Relationship Between Cutblocks and Adult Female Survival
There was no clear relationship between the amount of less than 8 year old cutblocks and adult female moose survival rates across the five study areas (Fig. 1). There was a negative relationship in the Entiako and JPRF study areas, a positive relationship in the Big Creek and Prince George South study areas and no relationship in the Bonaparte study area. 

```{r, total area cut <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (cut_8_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 1. Adult Female Moose Survival Rate by Total Area of Cutblocks Less Than 8 years 
old in the Study Area MCPs",
        x = "Total Area of Cutblocks Less Than 8 years old (km2)",
        y = "Adult Female Moose Survival Rate") 
```

Similarly, there was no clear relationship between the percent area less than 8 year old cutblocks and adult female moose survival rates across the five study areas (Fig. 2). There was a negative relationship in the Bonaparte and Entiako study areas, and a positive relationship in the Big Creek, JPRF and Prince George South study areas. 

```{r, proportion area cut <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (prop_cut_8_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 2. Adult Female Moose Survival Rate by Percent of Area that is 
Cutblocks Less Than 8 years old in the Study Area MCPs",
        x = "Percent of Area that is Cutblocks Less Than 8 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

When considering the realtionship between rate of change in 8 year old cutblocks and adult female moose survival rates across the five study areas, there was no clear realtionship across the five study areas (Fig. 3). There was a negative relationship in the Bonaparte and Entiako study areas, and a positive relationship in the Big Creek, JPRF and Prince George South study areas. 

```{r, change in proportion area cut <8 years old x survival rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (delta_prop_cut_8_year_area_ha*100), 
                   y = delta_af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 3. Change in Adult Female Moose Survival Rate by Change in Percent 
of Area that is Cutblocks Less Than 8 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Cutblocks Less Than 8 years old",
        y = "Change in Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

There was no clear relationship between the area of less than 15 year old cutblocks and adult female moose survival rates across the five study areas (Fig. 4). There was a negative relationship in the JPRF study area, a positive relationship in the Bonaparte and Entiako study areas and no relationship in the Big Creek and Prince George South study areas.

```{r, total area cut <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (cut_15_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 4. Adult Female Moose Survival Rate by Total Area of Cutblocks <15 
years old in the Study Area MCPs",
        x = "Total Area of Cutblocks <15 years old (km2)",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45)) 
```

There was generally a positive relationship between the percent area less than 15 year old cutblocks and adult female moose survival rates across the five study areas (Fig. 5). This did not support the hypothesis that more forestry disturbance increased mrotality risk for moose.  

```{r, proportion area cut <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (prop_cut_15_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 5. Adult Female Moose Survival Rate by Percent of Area that is 
Cutblocks <15 years old in the Study Area MCPs",
        x = "Percent of Area that is Cutblocks <15 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

There was also generally a positive relationship between the rate of change in area of cutblocks less than 15 years old change in adult female moose survival rates across the five study areas (Fig. 6). This did not support the hypothesis that more forestry disturbance increased mrotality risk for moose. 

```{r, change in proportion area cut <15 years old x survival rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (delta_prop_cut_15_year_area_ha*100), 
                   y = delta_af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 6. Change in Adult Female Moose Survival Rate by Change in Percent of 
Area that is Cutblocks <15 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Cutblocks <15 years old",
        y = "Change in Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

### Relationship Between Cutblocks and Calf/Cow Ratios
There was no clear relationship between the area of less than 8 year old cutblocks and calf/cow ratios across the five study areas (Fig. 7). There was a positive relationship in the Entiako and JPRF study areas and no relationship in the Big Creek, Bonaparte and Prince George South study areas.

```{r, total area cut <8 years old x calves/100 cows, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (cut_8_year_area_ha*0.01), 
                   y = calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 7. Moose Calves/100 Cows Ratio by Total Area of Cutblocks 
less than 8 years old in the Study Area MCPs",
        x = "Total Area of Cutblocks Less Than 8 years old (km2)",
        y = "Calves/100 Cows") 
```

Similarly, there was no clear relationship between the change in percent area of less than 8 year old cutblocks and change in calf/cow ratios across the five study areas (Fig. 8). There was a positive relationship in the Big Creek, Entiako and Prince George South  study areas and no relationship in the Bonaparte and JPRF study areas.

```{r, change in proportion area cut <8 years old x cow/calf rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (delta_prop_cut_8_year_area_ha*100), 
                   y = delta_calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 8. Change in Moose Calf/100 Cows Ratio by Change in Percent of Area 
that is Cutblocks Less Than 8 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Cutblocks Less Than 8 years old",
        y = "Change in Moose Calf/100 Cows Ratio") +
  theme (axis.text.x = element_text (angle = 45))
```

There was no clear relationship between the area of less than 15 year old cutblocks and calf/cow ratios across the five study areas (Fig. 9). There was a negative relationship in the Big Creek, Entiako and Prince George South study areas and a positive relationship in the Bonaparte and JPRF study areas.

```{r, total area cut <15 years old x calves/100 cows, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (cut_15_year_area_ha*0.01), 
                   y = calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 9. Moose Calf/100 Cows Ratio by Total Area of Cutblocks Less Than 15 
years old in the Study Area MCPs",
        x = "Total Area of Cutblocks Less Than 15 years old (km2)",
        y = "Calves/100 Cows") 
```

Similarly, there was no clear relationship between the change in percent area of less than 15 year old cutblocks and change in calf/cow ratios across the five study areas (Fig. 10). There was a negative relationship in the JPRF study area, a positive relationship in the Bonaparte and Prince George South study areas and no relationsip in the Big Creek and Entiako study areas. 

```{r, change in proportion area cut <15 years old x cow/calf rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
levels (data$name_sa) [levels(data$name_sa) == "John Prince Research Forest"] <- "JPRF"
ggplot (data, aes (x = (delta_prop_cut_15_year_area_ha*100), 
                   y = delta_calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Figure 10. Change in Moose Calf/100 Cows Ratio by Change in Percent of Area 
that is Cutblocks <15 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Cutblocks <15 years old",
        y = "Change in Moose Calf/100 Cows Ratio") +
  theme (axis.text.x = element_text (angle = 45))
```

In general, there was no clear relationship between forest cutblock disturbance and moose population parameters in the five study areas over time. If antyhing, these prelimanry resutls indicate an overall positive relationship between forestry cutblocks and moose survival, although this realtionship was not clear enough across study areas to suggest we woudl reject the null hypothesis with a statistical analysis. 

### Relationship Between Moutnain Pine Beetle Disturbance and Adult Female Survival


- disturabed stands <8 years ago and survival rate
  - no clear relationship
  - Entiako and Bonaparte is neagtive realtionship, but others positive or flat

```{r, total  MPB disturbed stands <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (mpb_all_8_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Total Area of Mountain Pine Beetle (MPB)
Disturbed Stands in the Study Area MCPs",
        x = "Total Area of MPB Disturbed Stands <8 years old (km2)",
        y = "Adult Female Moose Survival Rate") 
```

- what about proportion?
  - no clear pattern here either

```{r, proportion area mpb <8 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (prop_mpb_all_8_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Percent of Area that is 
Cutblocks <8 years old in the Study Area MCPs",
        x = "Percent of Area that is MPB Disturbed Stands <8 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

- if we consider a longer time-frame, 15 years
  - a bit more consistent here; lower survival in areas with more disturbance 

```{r, total area mpb <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (mpb_all_15_year_area_ha*0.01), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Total Area of Mountain Pine Beetle (MPB)
Disturbed Stands in the Study Area MCPs",
        x = "Total Area of MPB Disturbed Stands <15 years old (km2)",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45)) 
```

- proprotion?
 - pretty flat, maybe a weak effect, but not consistent when you consider overall disturabnce across 
   study areas

```{r, proportion mpb <15 years old x survival rate, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (prop_mpb_all_15_year_area_ha*100), 
                   y = af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Adult Female Moose Survival Rate by Percent of Area that is 
Mountain Pine Beetle (MPB) Disturbed Stands <15 years old in the 
Study Area MCPs",
        x = "Percent of Area of MPB Disturbed Stands <15 years old",
        y = "Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

- consider rate of change over time
  - no clear pattern here

```{r, change in proportion mpb <8 years old x survival rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (delta_prop_mpb_all_8_year_area_ha*100), 
                   y = delta_af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Change in Adult Female Moose Survival Rate by Change in Percent of Area that 
is Mountain Pine Beetle (MPB) Disturbed Stands <8 years old in the 
Study Area MCPs",
        x = "Change in Percent of Area that is Mountain Pine Beetle (MPB) Disturbed Stands <8 years old",
        y = "Change in Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

- if we look over a 15 year period.... 
  - here we have the strongest indicator
  - consistent negative relationship 

```{r, change in proportion area mpb <15 years old x survival rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (delta_prop_mpb_all_15_year_area_ha*100), 
                   y = delta_af_survival_rate_all)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Change in Adult Female Moose Survival Rate by Change in Percent of Area that 
is Mountain Pine Beetle (MPB) Disturbed Stands <15 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is MPB Disturbed Stands  <15 years old",
        y = "Change in Adult Female Moose Survival Rate") +
  theme (axis.text.x = element_text (angle = 45))
```

- what about calves?
  - over 8 year period
  - no consistent trend
  
```{r, total area mpb <8 years old x calves/100 cows, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (mpb_all_8_year_area_ha*0.01), 
                   y = calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Moose Calf/100 Cows Ratio by Total Area of Mountain Pine Beetle (MPB) 
Disturbed Stands <8 years old in the Study Area MCPs",
        x = "Total Area of Mountain Pine Beetle (MPB) Disturbed Stands  <8 years old (km2)",
        y = "Calves/100 Cows") 
```

- over 15 years
  - again, no consistent pattern

```{r, total area mpb <15 years old x calves/100 cows, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (mpb_all_15_year_area_ha*0.01), 
                   y = calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Moose Calf/100 Cows Ratio by Total Area of Mountain Pine Beetle (MPB) 
Disturbed Stands <15 years old in the Study Area MCPs",
        x = "Total Area of Mountain Pine Beetle (MPB) Disturbed Stands <15 years old (km2)",
        y = "Calves/100 Cows") 
```


- if we consider rate of change
 - no clear pattern across study areas

```{r, change in proportion area mpb <8 years old x cow/calf rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (delta_prop_mpb_all_8_year_area_ha*100), 
                   y = delta_calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Change in Moose Calf/100 Cows Ratio by Change in Percent of Area that 
is Mountain Pine Beetle (MPB) Disturbed Stands <8 years old in the Study Area MCPs",
        x = "Change in Percent of Area that is Mountain Pine Beetle (MPB) 
Disturbed Stands <8 years old",
        y = "Change in Moose Calf/100 Cows Ratio") +
  theme (axis.text.x = element_text (angle = 45))
```

- over a 15 year period 
  - no clear pattern again
  
```{r, change in proportion area cut <15 years old x cow/calf rate change, eval = T, echo = F}
data <- read.csv (here ("./data/data.csv"))
ggplot (data, aes (x = (delta_prop_mpb_all_15_year_area_ha*100), 
                   y = delta_calves_100cows)) +
  geom_point () +
  geom_smooth (method = lm) +
  facet_grid (.~name_sa, scales = "free") +
  labs (title = "Change in Moose Calf/100 Cows Ratio by Change in Percent of Area that 
is Mountain Pine Beetle (MPB) Disturbed Stands <15 years old in the 
Study Area MCPs",
        x = "Change in Percent of Area that is Mountain Pine Beetle (MPB) Disturbed Stands <15 years old",
        y = "Change in Moose Calf/100 Cows Ratio") +
  theme (axis.text.x = element_text (angle = 45))
```


- there may be some efefct of mpb on adult female surival rate, when consider 15 year effect, but in general no clear efefct here






























```{r exploratory stats and data vis, echo = T, message = F, warning = F}


  








### OUTLIERS ###
ggplot (data, aes (x = pttype, y = slope)) +
        geom_boxplot (outlier.colour = "red") +
        labs (title = "Boxplot DU7, Early Winter Slope at Available (0) and Used (1) Locations",
              x = "Available (0) and Used (1) Locations",
              y = "Slope")



### HISTOGRAMS ###
ggplot (rsf.data.terrain.water.du7.ew, aes (x = slope, fill = pttype)) + 
          geom_histogram (position = "dodge", binwidth = 5) +
          labs (title = "Histogram DU7, Early Winter Slope at Available (0) and Used (1) Locations",
                x = "Slope",
                y = "Count") +
          scale_fill_discrete (name = "Location Type")


### CORRELATION ###
corr.terrain.water.du7.ew <- rsf.data.terrain.water.du7.ew [c (10:15)]
corr.terrain.water.du7.ew <- round (cor (corr.terrain.water.du7.ew, method = "spearman"), 3)
ggcorrplot (corr.terrain.water.du7.ew, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Terrain and Water Resource Selection Function Model
            Covariate Correlations for DU7, Early Winter")
ggsave ("C:\\Work\\caribou\\clus_github\\reports\\caribou_rsf\\plots\\corr_terrain_water_du7_ew.png")



```



### Model


